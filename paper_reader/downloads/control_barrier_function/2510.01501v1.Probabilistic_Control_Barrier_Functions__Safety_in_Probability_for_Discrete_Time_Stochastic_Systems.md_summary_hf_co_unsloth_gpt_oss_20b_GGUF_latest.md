# Probabilistic Control Barrier Functions: Safety in Probability for Discrete‑Time Stochastic Systems  
**Authors**: Pol Mestres, Blake Werner, Ryan K. Cosner, Aaron D. Ames  
**Affiliations**: Department of Mechanical and Civil Engineering, Caltech; Department of Mechanical Engineering, Tufts University  
**Published**: 2025 (see bibliography in the reference list; full citation available in the paper)

---

## Abstract
The paper introduces *probabilistic control barrier functions* (pCBFs) for discrete‑time nonlinear systems subject to stochastic, possibly unbounded, disturbances.  
A pCBF is a continuous function \(h:\mathbb{R}^n\to\mathbb{R}\) such that, for a safe set \(C=\{x:h(x)\ge0\}\), satisfies a probabilistic super‑martingale inequality:

\[
h(F(x,u,d)) \;\ge\;\alpha\,h(x)\quad\text{w.p.\ }1-\delta ,
\]

where \(F\) is the plant dynamics, \(\alpha\in[0,1]\) and \(\delta\in(0,1)\).  
Using this notion, the authors prove that a controller guaranteeing the pCBF condition over each step yields probabilistic safety over a finite horizon.  
They further provide a collection of verifiable sufficient conditions:
- *Moment‑based*: Markov (first moment + boundedness), Cantelli (first & second moments),
- *Data‑driven*: Hoeffding (bounded samples), Scenario (randomized feasibility), Conformal (prediction‑based) methods.

These conditions are shown to be convex (or tractable) in many practical cases, enabling optimization‑based controller synthesis.  
Simulations and hardware experiments on a Quadruped robot validate the approach.

---

## 1. Introduction & Motivation
• Classic CBFs assume bounded, deterministic disturbances; real systems often face stochastic, unbounded uncertainties (e.g., Kalman filtering errors, SLAM).  
• Existing stochastic‑CBF works are either limited to continuous‑time, known‑distribution, or overly conservative.  
• Goal: provide *probabilistic* safe controllers for *discrete‑time* stochastic dynamics with *prescribed probability* guarantees over a finite horizon.

---

## 2. Contributions (as stated)
1. **Define pCBFs** and prove that they guarantee safety over a finite horizon.  
2. **Moment‑based sufficient conditions** (Markov, Cantelli) that only require first/second moments of \(\Delta h\).  
3. **Data‑driven sufficient conditions** (Hoeffding, Scenario, Conformal) using samples of the disturbance.  
4. **Discussion of convexity** of constraints arising in each condition.  
5. **Experimental validation** on a Quadruped robot (simulation & hardware).

---

## 3. Main Definitions & Notation
| Symbol | Meaning |
|--------|----------|
| \(x_t\in\mathbb{R}^n\) | state at step \(t\) |
| \(u_t\in \mathbb{R}^m\) | control input |
| \(d_t\in\mathbb{R}^d\) | disturbance i.i.d. \(\sim D\) |
| \(F(x,u,d)\) | discrete‑time dynamics |
| \(h:\mathbb{R}^n\to\mathbb{R}\) | CBF candidate |
| \(C=\{x:h(x)\ge0\}\) | safe set |
| \(\alpha\in[0,1]\) | contraction factor |
| \(\Delta h(x,u,d)=h(F(x,u,d))-h(x)\) | CBF increment |

*Probabilistic safety* over horizon \(H\) with failure margin \(\epsilon\):

\[
\Pr\Big[\cap_{t=0}^{H-1}\{x_t\in C\}\Big] \;\ge\;1-\epsilon.
\]

A *δ‑probabilistic CBF* satisfies 

\[
\Pr[\Delta h(x,u,d)\le 0]\;\le\;\delta, \qquad \forall x\in C .
\]

---

## 4. Key Theorems

### Proposition 1 (Finite‑horizon guarantee)
If for every \(x\in C\) there exists \(u\) with \(\Pr(\Delta h(x,u,d)\le0)\le\delta\), then for any state‑feedback controller respecting these local constraints, the safety probability over horizon \(H\) satisfies

\[
\Pr[\cap_{t=0}^{H-1}\{x_t\in C\}] \;\ge\;(1-\delta)^H .
\]

Thus \(\epsilon\) can be chosen to ensure

\((1-\delta)^H\ge 1-\epsilon\).

---

### Markov‑based Condition (Prop 2)
Assume a deterministic upper bound \(b>0\) on \(\Delta h\) (a.s.) and  

\[
\mathbb{E}_d[b-\Delta h(x,u,d)]\;\le\;b\,\delta.
\]

Then \(h\) is a δ‑pCBF.

**Commentary**: Markov’s inequality gives \(\Pr[\Delta h>0]\le \mathbb{E}[b-\Delta h]/b\).

---

### Cantelli‑based Condition (Prop 4)
Assume existence of a measurable \(u(x)\) so that  

\[
\frac{\mathbb{E}_d[\Delta h]+\,\sqrt{\operatorname{Var}_d[\Delta h]}\;\sqrt{\frac{1-\delta}{\delta}}}{\;\le\;0\,}.
\]

Then \(h\) is a δ‑pCBF.

*Uses both mean and variance; tighter than Markov.*

---

### Convexity Remarks (Corollaries 3, 5)
- If \(h\) is convex and \(\alpha\in[0,1]\), the Markov/01 inequality can be relaxed to  

\[
h(\mathbb{E}_d[F(x,u,d)]) \;\ge\;\alpha h(x).
\]

- If \(h\) is concave with bounded Hessian \(\|\nabla^2 h\|\le\lambda\), then  

\[
h(F(x,u,d))\;\ge\;\alpha h(x) - \frac{\lambda}{2} \mathbb{E}_d[\|F(x,u,d)-\mathbb{E}[F(x,u,d)]\|^2].
\]

These deterministic bounds yield convex constraints on \(u\) (e.g., QCQPs when \(F\) is affine in \(u\) and \(h\) quadratic).

---

### Hoeffding‑based Condition (Prop 7)
If \(\Delta h(x,u,d)\) is almost surely bounded in \([a,b]\) and with probability at least \(1-\beta\)

\[
\mathbb{E}_d[\Delta h(x,u,d)]\;\le\;-\varepsilon(b-a),
\quad \text{with}\; \beta\ge 2\exp(-2N\varepsilon^2/(b-a)^2),
\]

then \(h\) is a δ‑pCBF with confidence \(1-\beta\).

*Uses samples \(\{d^{(i)}\}_{i=1}^N\) to compute \(\mathbb{E}\) estimate.*

---

### Scenario‑based Condition (Prop 8)
If for every \(x\in C\) there exists an input \(u\) such that

\[
\max_{d\in D}[-\Delta h(x,u,d)]\;\le\;\delta,
\]
and the horizon‑wise constraint \(\mathbb{P}[-\Delta h(x,u,d)\le0]\le\delta\) is satisfied for *every* sampled scenario (finite \(N\)), then the safety guarantee holds with confidence \(1-\beta\) where \(N\) satisfies the *scenario bounds* (\(N\ge 2\delta(\log(1/\beta)+d)\)).

---

### Conformal‑prediction Condition (Prop 9)
If for each \(x\) an input \(u\) can be chosen such that

\[
\ell_{\text{conf}}:=\text{Quantile}_{1-\delta}\big(-\Delta h(x,u,d(i))_{i=1}^N\;\ge\;- \Delta h(x,u,d)\quad\forall d,
\]

then \(h\) is a δ‑pCBF with confidence \(1-\beta\).  
*(Uses nonparametric conformal prediction to estimate a high‑probability upper bound.)*

---

## 5. Method / Approach
1. **Define \(h\)**: Often taken as a Lyapunov‐type function or distance to the boundary of \(C\).  
2. **Choose a horizon \(H\)** and desired failure \(\epsilon\).  
3. **Select a verification method** (Markov, Cantelli, Hoeffding, Scenario, or Conformal).  
4. **Formulate a local optimization** at each step that finds the closest control to a nominal controller subject to the chosen constraint (e.g., QCQP, SOCP, MIQP).  
5. **Integrate over the horizon**: because constraints are local, they guarantee the *overall* safety.

---

## 6. Experiments / Data / Results

### 6.1 Simulation
- **System**: Quadruped robot with dynamics \(x_{k+1}=F(x_k,u_k,d_k)\) (eqs. (not reproduced fully)).  
- **Disturbance**: Gaussian \(d_k\sim \mathcal{N}(0,\sigma^2)\) affecting the \(y\)-direction.  
- **Setup**:
  - Time horizon \(H=20\), \(\alpha=0.01\), \(\delta=0.1\), \(\beta=0.01\).  
  - Nominal controller \(k_{\text{nom}}=[0.2,0,-\theta]\).  
  - Data sizes: Hoeffding \(N=3252\), Scenario \(N=113\), Conformal \(N=300\).  
- **Procedure**: At every time step, solve the relevant optimization to obtain control \(\mathbf{u}_t\).  
- **Results** (Fig. 1):
  - “Number of unsafe trajectories” vs. disturbance variance \(\sigma^2\) and vs. horizon length.  
  - All data‑driven methods (Markov, Cantelli, Hoeffding, Scenario, Conformal) produced *far fewer* unsafe trajectories than the theoretical bound (\((1-\delta)^H \approx 0.12\)).  
  - Observed trade‑off: tighter constraints → more violations but earlier infeasibility for small \(\sigma\).  
- **Table I** (execution times, feasibility thresholds):
  - Execution times (ms): Markov 3.47, Cantelli 3.78, Hoeffding 3.89, Scenario 79.96, Conformal 5.65.  
  - Smallest \(\sigma\) leading to infeasibility: Markov 0.03 → 0.16; Hoeffding 0.13; Scenario 0.21; Conformal 0.20; Martingale baseline 0.25.  

### 6.2 Hardware
- **Platform**: Unitree GO2 quadruped.  
- **Course**: 3 m long 1 m wide corridor with slanted wooden ramp and slippery plates (Fig. 3).  
- **Dynamics**: Similar to simulation (eqs. (24)).  
- **Objective**: Traverse at 1 m/s while remaining inside \(C\).  
- **Controllers compared**:
  1. Nominal (no safety filter).  
  2. *Naïve* CBF filter (assumes zero disturbance).  
  3. **Hoeffding‑pCBF** filter.  
- **Disturbance data** collected over 5000 steps.  
- **Outcome** (Fig. 4):
  - Nominal and naïve filters consistently violate safety (robot deviates laterally).  
  - Hoeffding filter reduces *frequency* and *magnitude* of constraint violations, successfully operating in 4/5 test roll‑outs.

---

## 7. Discussion & Analysis
- **Conservatism**: All proposed conditions are *sufficient but not necessary*; envelope of inequalities (Markov, Cantelli) is conservative.  
- **Convexity**: Markov & Cantelli conditions become convex for affine dynamics and quadratic CBFs (QCQP). Scenario/Conformal lead to linear or MIQP formulations.  
- **Scalability**: Hoeffding requires large sample size for small \(\beta\); Scenario may involve many constraints; Conformal offers moderate complexity via integer programming.  
- **Comparison to Related Work**: Extends deterministic CBFs (Agrawal–Sreenath), continuous‑time stochastic CBFs (Clark 2021), and recent scenario‑MPC (D. Nascimiento 2024).  

---

## 8. Conclusions
- Introduced *probabilistic CBFs* providing explicit probabilistic safety guarantees over finite horizons.  
- Derived *moment‑based* (Markov, Cantelli) and *data‑driven* (Hoeffding, Scenario, Conformal) verifiable conditions.  
- Illustrated computational tractability and demonstrated use on a real robot.  
- Future research: Reduce conservatism, integrate with state‑estimation uncertainty (Kalman, SLAM), and develop continuous‑time analogues.

---

## 9. Key Claims & Contributions (Summarized)
1. **pCBF definition** generalises CBFs to stochastic settings.  
2. **Finite horizon safety** follows directly from the local probability bound.  
3. **Markov & Cantelli** conditions are simple, require only first or first‑second moments.  
4. **Hoeffding, Scenario, Conformal** provide *confidence‑bounded* conditions using sample data.  
5. **Optimization feasibility**: many conditions lead to convex or tractable programs (QCQP, SOCP, MIQP).  
6. **Hardware validation** shows practical applicability and comparably low failure rates.

---

## 10. Important Figures & Tables
- **Fig. 1**: Unsafe trajectories vs. disturbance variance and horizon length for each method.  
- **Fig. 2**: Trajectory evolution for σ = 0.06 (visual demonstration).  
- **Fig. 3**: Experimental corridor layout.  
- **Fig. 4**: Trajectory statistics for hardware experiments.  
- **Table I**: Computation time (ms) and feasibility threshold σ₀ for each method.

---

## 11. Limitations & Open Questions
- Conditions are *sufficient*; existence of *necessary* conditions remains open.  
- The *gap* between theoretical bounds and empirical performance suggests unexplored conservatism.  
- Extension to *continuous‑time* models and *state‑dependent* uncertainty not addressed.  
- Integration with high‑frequency state‑estimator filters (e.g., Kalman, SLAM) remains a future direction.

---

## 12. References to Original Sections
- Definitions 1–2: Section II‑A.  
- Proposition 1: Section II‑A.  
- Markov & Cantelli conditions: Section III.  
- Hoeffding, Scenario, Conformal: Section IV.  
- Experiments: Section V.  
- CPU times & infeasibility threshold: Table I (Section V‑A).  
- Table I – details: page ?? (in appendix).  

---

## 13. Executive Summary (optional)
- *Inputs*: Discrete‑time stochastic dynamics, safe set \(C\), nominal controller.  
- *Output*: Safe controller within probabilistic guarantee.  
- *Approach*: Verify pCBF via moment or data conditions → local QCQP/SOCP/MIQP → control synthesis.  
- *Result*: Significantly fewer safety failures than deterministic CBFs and theoretical upper bound.  
- *Implication*: Enables deployment of safety‑critical controllers in uncertain real‑world scenarios.  

---