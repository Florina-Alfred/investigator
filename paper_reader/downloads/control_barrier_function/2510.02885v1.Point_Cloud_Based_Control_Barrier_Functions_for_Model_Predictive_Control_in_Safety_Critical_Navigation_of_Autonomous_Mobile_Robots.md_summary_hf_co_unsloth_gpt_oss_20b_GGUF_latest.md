**Title & Citation**  
*Point Cloud-Based Control Barrier Functions for Model Predictive Control in Safety-Critical Navigation of Autonomous Mobile Robots*  
Faduo Liang, Yunfeng Yang, Shi‑Lu Dai (School of Automation Science and Engineering, South China University of Technology, Guangzhou, China) – Published in *IEEE Robotics & Automation Letters* (2024).  
Code: <https://github.com/Faduo-Liang/PCCBF-MPC>  

---

### Abstract  
The authors present a motion‑planning and control framework that integrates real‑time perception, model‑predictive MPC, and point‑cloud‑based Control Barrier Functions (CBFs) for collision‑free navigation of autonomous mobile robots in environments with both static and dynamic obstacles.  Depth images are converted to voxel occupancy maps, where a Kalman filter predicts dynamic clouds; the predictions are merged to produce a *Forward‑Time‑Domain* (FTD) map.  By detecting *risk points* (i.e., near‑collision points) on the FTD map and formulating CBF constraints from those points, the MPC can plan safe trajectories while still respecting robot dynamics.  Experimental results (Gazebo / TurtleBot‑4) show superior safety and robustness vs. two baseline methods (DCBF‑NMPC and Depth‑CBF‑QP).  

---  

### Introduction & Motivation  
- Collision avoidance of mobile robots in mixed static/dynamic environments remains hard because obstacle modeling (usually ellipsoids) yields excess conservatism and may miss irregular shapes.  
- Prior works either cluster obstacle point clouds (DBSCAN) [6] or use learned detectors [13,15]; both still struggle with complex scenes.  
- NMPC is attractive for tight integration of planning & control but usually treats obstacles as simple shapes; control barrier functions (CBFs) are a promising technique for guaranteeing safety by enforcing invariance of a safe set [17,20].  
- Existing CBF‑MPC methods mainly use *current* state only or use ellipsoidal approximations; they lack *predictive* or *history* context for dynamic obstacles.  
- **Goal of this paper**: develop a *point‑cloud‑based CBF–NMPC* that (i) precisely predicts dynamic clouds, (ii) identifies high‑risk points from FTD map, and (iii) formulates CBF constraints that enforce safety in real time.  

---  

### Methods / Approach  

#### 1. Perception Pipeline  
- RGB‑D camera → depth image → voxel occupancy map via voxel‑filter [13] → point clouds.  
- **Static point cloud**: `P_static = {(x_i, y_i, z_i) | M_s^i = 0}` (eq. 1).  
- **Dynamic point cloud**: `P_dyn^0 = {(x_i^0, y_i^0, z_i^0) | M_d^i = 0}` (eq. 2).  
- **YOLO‑Fusion detector**:  
  - 2‑D YOLOFastestDet on RGB image → 2‑D bounding boxes.  
  - Extract corresponding point cloud from occupancy map.  
  - Use DBSCAN to cluster and keep largest cluster → 3‑D bounding box.  
  - Provides real‑time 3‑D detection for pedestrians; reduced computational load compared to earlier methods [13].  

#### 2. Local Map Construction (FTD map)  
- Separate static & dynamic point clouds.  
- Predict dynamic cloud over horizon `N` using **Kalman filter (KF)** with a constant‑velocity model.  
- Obtain `P_dyn,k = {(x_i^k, y_i^k, z_i^k) | M_d^i=0}` for `k = 0 … N‑1` (eq. 3).  
- **FTD map**: `P_FTD = {P_static} ∪ {P_dyn,0} ∪ … ∪ {P_dyn,N‑1}`.  
- Enhance query efficiency by storing each time slice in a *KD‑Tree* (Fig. 4).  

#### 3. Control Barrier Function (CBF) Generation  
- Safe set defined as super‑level set of `h(x)` (eq. 4).  
- For continuous dynamics:  
  - `h(x) > 0` ⇒ x in safe set.  
  - Discrete‑time barrier condition (3) → (4): `h(x_{k+1}) ≥ (1−γ) h(x_k)` where γ∈(0,1).  
- **Barrier function based on environment point cloud**:  
  - `h(x_k) = min_{i} [||(x_k − p_i)||] – δ` (eq. 5).  
  - δ>0 is minimum safe distance.  
- For NMPC integration:  
  - Replace `x_k` with *risk points* `x_k^*` from FTD map: `h(x_k, u_k) ≥ (1-γ) h(x_k)` (eq. 6).  

#### 4. NMPC‑Based Planning & Control  
- Robot dynamics:  
  - `x_{t+1} = f(x_t, u_t)` where `x_t = [x_t, y_t, θ_t]` (eq. 7).  
- MPC horizon: `N=30`, weight matrices `Q, R, W, Q_N`.  
- Objective: minimize stage cost `q(x_t+k, u_t+k) = ||x_tar − x_t+k||^2 Q + ||u_t+k||^2 R + ||x_t+k – x_t+k−1||^2 W` (eq. 8a).  
- Constraints: dynamics (8b), input constraints (8c), terminal constraint (8e), **CBF constraint** (8f) (`h(x_t+k, u_t+k) ≥ (1−γ) h(x_t+k−1)`).  
- Solve at every 0.1 s (10 Hz) using CasADi.  
- If QP fails, fallback to last feasible control action.  

#### 5. Risk Point Identification  
- **Static risk points**: detect *forward* and *inverse* collisions between predicted robot path and FTD map (Fig. 5).  
  - Forward collision: first predicted time step where robot enters unsafe set: `k_c = min{ k | h_sta(x^*, u) ≤ 0 }` (eq. 9).  
  - Take collision point as `x_*^sta`.  
  - Maintain a *historical* set `x_*^his` that removes invalid points, enabling management in dense spaces.  
- **Dynamic risk points**: for each dynamic cloud slice `P_dyn,k`, evaluate CBF (10).  
  - If `h_dyn(x_now, u_now) ≤ 0`, select point as `x_*^{dyn}`.  
  - Use dynamic barrier function `h_dyn(x_k, u_k) ≥ (1−γ_d) h_dyn(x_k−1)` (eq. 11).  

- The union of static & dynamic risk points constitutes the *high‑risk set* used in MPC CBF constraints.  

---  

### Experiments / Data / Results  

#### Experimental Setup  
- ROS Noetic on Ubuntu 20.04.  
- Hardware: 2.9 GHz AMD Ryzen 7 4800H CPU + NVIDIA GTX 1650 GPU.  
- Perception: 5 m × 5 m grid, 0.1 m resolution, `V_dyn = 0.1 m/s`, `V_vote = 0.8 m/s`, `T_ratio = 0.5`.  
- Planner: horizon `N = 30`, CasADi.  
- Sensors: ZED‑2i RGB‑D camera (FOV).  

#### Real‑World Scenarios (Fig. 7)  
- Platform: TurtleBot‑4 (lin. vel ≤ 0.3 m/s, ang. vel ≤ 1.2 rad/s).  
- Goal distance: 8.5 m, pedestrian speed ≈1.2 m/s.  
- Safety buffer `δ = 0.271 m`.  
- Observed behavior:  
  - When approaching a *blackboard* (hollow static obstacle), algorithm identifies static risk points at legs, chooses interior passage → **less conservative** than circumnavigational.  
  - When encountering pedestrians, Kalman filter predicts future states over horizon; dynamic risk points identified; robot manages safe gap.  

#### Simulation Scenarios (Fig. 8)  
- Platform: Jackal in Gazebo.  
- Parameters: goal 15 m, pedestrian 1.0 m/s, robot speed ≤ 1.2 m/s.  
- Compared against:  
  1. **DCBF‑NMPC** [2] – Kalman filter + dynamic CBF + ellipsoidal obstacle model.  
  2. **Depth‑CBF‑QP** [8] – QP controller + depth‑based CBF, no history/future context.  
- Metrics:  
  - μ_d [m] − minimum distance to obstacles along trajectory.  
  - ˆμ_l – relative mean path length.  
  - ˆμ_s – relative mean smoothness.  
  - μ_t [s] – time to goal.  
  - μ – success rate.  
- Table I (results):  
  - Our algorithm: μ_d=0.327 m, ˆμ_l=1.000, ˆμ_s=1.00, μ_t=16.10 s, μ=100 %.  
  - DCBF‑NMPC: μ_d=0.609 m, ˆμ_l=1.086, ˆμ_s=1.98, μ_t=20.75 s, μ=70 %.  
  - Depth‑CBF‑QP: collision (0 μ_d) → fail.  

- Discussion:  
  - Depth‑CBF‑QP fails due to lack of historical/predictive context, leading to close‑to‑collision behavior in dense scenes.  
  - DCBF‑NMPC becomes overly conservative because ellipsoidal obstacle models inflate safe radius; also fails to handle irregular shapes (tables) → contributes to path inefficiency.  
  - Our FTD + risk‑point + CBF approach mitigates both issues, yielding safe, smooth, and efficient paths.  

---  

### Discussion & Analysis  

- **Why risk‑point identification improves safety:**  
  - By detecting the *first* incremental collision (forward) and the *most relevant inverse* collision (prevent entrapment), the algorithm provides a real‑time safe buffer that adapts to robot state.  
  - Historical risk points ensure that high‑priority obstacles are not forgotten as the robot advances.  
- **CBF integration into NMPC** ensures that the safety constraint is enforced *within* the optimization; no soft penalty but hard inequality, guaranteeing safe trajectory if solution exists.  
- **Computational profile**: perception pipeline 33 Hz; planner 10 Hz; solver time acceptable on GPU‑enabled system; plain CPU version may need lower horizon (N=20) for tight real‑time budgets.  
- **Robustness**: FTD map includes predicted dynamic point clouds; approximated via constant velocity model; small diffusion due to Kalman filter's uncertainty handling.  
- **Comparison to prior works**:  
  - [8] uses point cloud but treats obstacles generically; no predictive risk; potentially results in conservatism or collisions.  
  - [2] also uses dynamic CBF; but obstacle modeling via ellipsoids; algorithm proposed here uses raw point clouds → better shape fidelity.  

---  

### Conclusions  

- Developed a *point‑cloud‑based control barrier‑function* framework combined with NMPC that handles both static and dynamic obstacles in unknown, unstructured indoor environments.  
- FTD map provides forward predictions; risk‑point detection and CBF constraints supply safety guarantees.  
- Experimental evaluation demonstrates better safety (smaller μ_d), improved path efficiency (lower ˆμ_l), smoother navigation (lower ˆμ_s), and higher success rates compared to DCBF‑NMPC and Depth‑CBF‑QP.  
- Open question: scaling the method to larger, highly dynamic scenes (e.g., crowds) where Kalman filter may under‑predict nonlinear motions.  

---  

### Key Claims & Contributions  
1. **Claim:** FTD map combined with Kalman‑filtered dynamic point clouds yields accurate future obstacle distribution.  
   - **Evidence:** Visual and quantitative results: safe navigation near hollow static obstacle and pedestrians.  
2. **Claim:** Risk‑point detection through forward–inverse collision detection provides efficient, real‑time identification of high‑risk points.  
   - **Evidence:** Table I shows improved safety over baseline methods, especially in dense scenarios.  
3. **Claim:** Integration of point‑cloud‑based CBFs into NMPC gives guarantee of forward invariance of safe set while respecting dynamics.  
   - **Evidence:** No collisions in simulations/real tests; only safe trajectory; theoretical support from CBF theorems [17].  

---  

### Definitions & Key Terms  

- **Forward‑Time‑Domain (FTD) map:** a collection of static point cloud plus a prediction horizon of dynamic clouds (eq. 3).  
- **Risk point:** a point from the FTD map that, if collided, would violate safety barrier condition.  
- **Control Barrier Function (CBF):** a continuous function h(x) whose super‑level set defines safe states; discrete‑time safety condition: `h(x_{k+1}) ≥ (1−γ)h(x_k)`.  
- **Kalman filter (KF):** recursive predictor used to estimate dynamic point cloud states with constant velocity assumption.  
- **Boilerplate α_g**: α-function parameter controlling barrier decay rate; in this paper, γ used similarly.  

---  

### Important Figures & Tables  

| Figure | Description | Significance |
|--------|-------------|--------------|
| Fig. 1 | Experimental setup & trajectory (green) in indoor environment. | Demonstrates real‑world deployment. |
| Fig. 2 | Collision avoidance framework pipeline. | Shows integration of perception & MPC. |
| Fig. 3 | YOLO‑Fusion detector architecture. | Highlights 2‑D → 3‑D detection process. |
| Fig. 4 | FTD map structure (KD‑trees). | Shows efficient collision checking. |
| Fig. 5 | Static risk point detection (forward–inverse). | Shows method for static CBF identify. |
| Fig. 6 | Dynamic risk point detection (within prediction horizon). | Shows method for dynamic CBF. |
| Fig. 7 | Real‑world experiment snapshots. | Visual evidence of robot navigating with obstacles. |
| Fig. 8 | Simulation results. | Demonstrates performance vs baselines. |
| Table I | Comparison metrics μ_d, ˆμ_l, ˆμ_s, μ_t, μ. | Quantitative evidence of superiority. |

---  

### Limitations & Open Questions  

- **Kalman filter assumption:** Constant‑velocity may not hold for pedestrians turning sharply; inaccuracies degrade risk‑point detection.  
- **Computational burden:** Building KD‑trees for each time slice adds overhead; scaling to thousands of points may require optimization.  
- **Single‑horizon CBF model:** The current algorithm uses a fixed safety buffer δ; dynamic adaptation of δ based on obstacle size or robot speed is not discussed.  
- **Robustness to perception noise:** Depth sensor noise could affect occupancy voxel map generation; not quantified.  

---  

### References to Original Sections  

- Perception pipeline: Section III-A.  
- YOLO‑Fusion: Section III-A cum Fig. 3.  
- FTD map: Section III-B.  
- Risk‑point identification: Section III-E, Fig. 5&6.  
- MPC formulation: Section III-D, Eq. 8–8f.  
- Experiments: Section IV-A & B; Fig. 7 & 8, Table I.  

---  

### Executive Summary (Key Takeaways)  

1. Merges point‑cloud perception, Kalman prediction, and CBF into a single NMPC loop.  
2. Generates a forward‑time map and identifies high‑risk points via forward & inverse collision checks.  
3. Enforces safety as hard constraints inside the MPC, guaranteeing forward invariance.  
4. Outperforms state‑of‑the‑art dynamic‑CBF-MPC and depth‑CBF-QP in simulations and real indoor tests.  
5. Code and videos publicly available (<https://github.com/Faduo-Liang/PCCBF-MPC>).  
6. Method remains limited by constant‑velocity assumption and scaling to high‑density scenes.  

---  

### Supplementary Material (if present)  

- Source code on GitHub (links provided).  
- Demonstration video in attached documents (not reproduced here).  

---