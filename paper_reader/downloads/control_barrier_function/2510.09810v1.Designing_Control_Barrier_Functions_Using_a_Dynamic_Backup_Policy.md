## Designing Control Barrier Functions Using a Dynamic Backup Policy /star

Victor Freire ∗ and Marco M. Nicotra ∗

∗ Department of Electrical, Computer &amp; Energy Engineering, University of Colorado, Boulder, CO 80309 USA

(e-mail: vifr9883@colorado.edu; marco.nicotra@colorado.edu).

Abstract: This paper presents a systematic approach to construct control barrier functions for nonlinear control affine systems subject to arbitrary state and input constraints. Taking inspiration from the reference governor literature, the proposed method defines a family of backup policies, parametrized by the equilibrium manifold of the system. The control barrier function is defined on the augmented state-and-reference space: given a state-reference pair, the approach quantifies the distance to constraint violation at any time in the future, should the current backup policy reference remain constant. Sensitivity analysis is then used to compute the (possibly nonsmooth) Jacobian with respect to the augmented state vector. To showcase its simple yet general nature, the proposed method is applied to an inverted pendulum on cart.

Keywords: Control barrier functions and state space constraints, Application of nonlinear analysis and design, Reference governors, Constrained control.

## 1. INTRODUCTION

Control barrier functions (CBFs) are powerful tools to design controllers for safety-critical systems. However, they are difficult to synthesize for general systems under arbitrary state and input constraints. In many applications, practitioners resort to candidate CBFs because they are easier to design and achieve good performance with tuning and the use of slack variables. However, they lack the rigorous safety guarantees of valid CBFs.

Although the modern definition of CBFs was stated in Ames et al. (2017), their systematic design remains an open problem. Recent techniques include the following: Harms et al. (2024) uses machine learning to design and implement CBFs; Dai et al. (2024) uses sum-of-squares to design polynomial CBFs; Jang and Kim (2024) uses control Lyapunov functions to design families of CBFs; Lindemann et al. (2024) uses expert demonstrations to design robust CBFs; Shakhesi et al. (2025) partitions the state-space to search for counterexamples to guide the construction of CBFs; Choi et al. (2021), proposes robust control barrier-value functions, which unify the Hamilton-Jacobi reachability and CBF methods. Most relevant to this paper, Chen et al. (2021) and Van Wijk et al. (2024) propose backup CBFs, which leverage a prespecified control policy to maintain safety guarantees.

Prior work by the authors showed that it is possible to design proper CBFs using tools from the reference governor literature. Specifically, Freire and Nicotra (2025) proved that dynamic safety margins (DSMs) are CBFs in the augmented state-reference space. This led to the definition of Lyapunov-based DSM-CBFs in Freire and Nicotra (2025) and passivity-based DSM-CBFs in Freire et al. (2025). In this paper, we extend the trajectory-based

/star This research is supported by the NSF-CMMI Award #2411667.

DSMs proposed in Nicotra and Garone (2018) to construct trajectory-based DSM-CBFs. Although the resulting approach is conceptually similar to the backup CBFs detailed in Chen et al. (2021) and Van Wijk et al. (2024), this paper features several key contributions: (a) the backup policy is parametrized via the equilibrium manifold of the system, (b) the backup policy is dynamic because its parametrization is time-varying (c) under mild assumptions, it is shown that the underlying sensitivity matrices are asymptotically stable, and (d) the potential nonsmoothness of the resulting CBF is rigorously addressed using Clarke generalized Jacobians.

The paper is organized as follows: Section 2 provides a formal definition of CBFs, DSMs, and DSM-CBFs; Section 3 performs a sensitivity analysis of the prestabilized trajectories; Section 4 is the main contribution of the paper: it proves that trajectory-based DSMs are valid CBFs and also addresses finite horizon/smoothness considerations that complicate the direct implementation of the derived constrained control policy. These considerations lead to a more tractable policy that is shown to be sufficient for safety. Moreover we show that the underlying optimization problem is always feasible; Section 5 showcases the simplicity and effectiveness of the proposed CBF design method by benchmarking it on a challenging nonlinear system. Open source code of the proposed numerical validations can be found in our GitHub repository 1 and can be easily modified to other constrained systems.

## 2. PRELIMINARIES

Consider a control affine system

<!-- formula-not-decoded -->

subject to state and input constraints x ∈ X and u ∈ U .

1 https://github.com/ROCC-Lab-CU-Boulder/traj-DSM-CBF

Assumption 1. The functions f : R n → R n and g : R n → R m are continuously differentiable.

Assumption 2. The sets X ⊂ R n and U ⊂ R m are closed.

Our objective is to provide a simple yet rigorous approach to enforce constraints using control barrier functions. To this end, we include a standard assumption from the reference governor (RG) literature: they apply to any system that admits a connected path of stabilizable equilibrium points. As noted in Garone et al. (2017), this encompasses a wide range of meaningful systems and applications.

Assumption 3. The control affine system (1) admits an equilibrium manifold parameterized by v ∈ R l . Specifically, there exist continuous functions ¯ x : R l → R n and ¯ u : R l → R m such that

<!-- formula-not-decoded -->

Moreover, there exists a continuously differentiable control policy π : R n × R l → R m such that ¯ x ( v ) is an asymptotically stable equilibrium point with an open region of attraction D v ⊂ R n .

Assumption 3 requires an understanding of the equilibrium points of the system and the ability to design a (local) stabilizing control law. The following subsections summarize existing results from the CBF and RG literatures.

## 2.1 Control Barrier Functions

Control barrier functions can be used to synthesize safety filters that modify a nominal control law κ ( x ) as little as necessary to enforce constraints.

Definition 1. (Ames et al. (2017)). Let D⊂ R n be an open set. A continuously differentiable function h : D → R is a control barrier function (CBF) if there exists a class K ∞ function α : [0 , ∞ ) → [0 , ∞ ) such that

<!-- formula-not-decoded -->

where C = { x ∈ D | h ( x ) ≥ 0 } , and L f h and L g h are the Lie derivatives of h along f and g , respectively.

If the zero-superlevel set of h ( x ) is closed in R n and satisfies C ⊂ X , the solution to the CBF safety filter

<!-- formula-not-decoded -->

can be used as a control policy that approximates κ ( x ) as much as possible while also enforcing constraints.

<!-- formula-not-decoded -->

Although simple to implement, the main drawback of CBFs is that finding a suitable function h ( x ) is generally challenging. However, in Freire and Nicotra (2025), we showed that CBFs can be constructed using dynamic safety margins.

## 2.2 Dynamic Safety Margins

Under Assumption 3, let π ( x , v ) be a prestabilizing control policy. Given the prestabilized dynamics

<!-- formula-not-decoded -->

dynamic safety margins quantify the risk of constraint violation at any time in the future, should the virtual reference v remain constant.

In the context of this paper, it is convenient to generalize sets of interest to the augmented state-reference space R n × R l . Notably, we define the augmented constraint set

<!-- formula-not-decoded -->

where

<!-- formula-not-decoded -->

is the set of steady-state admissible references and

<!-- formula-not-decoded -->

is a reference-dependent set of state constraints. Note that ˜ X is closed in R n × R l . The following technical assumption ensures that the prestabilizing policy has a well-behaved region of attraction.

Assumption 4. The augmented region of attraction

<!-- formula-not-decoded -->

is open in R n × R l . Moreover, the augmented constraint set satisfies ˜ X ⊂ ˜ D .

Remark 1. With no loss of generality, ˜ X ⊂ ˜ D can always be enforced by introducing state constraints that capture the stability requirements of the prestabilizing controller.

We are now ready to provide a slightly stronger definition of DSMs that requires smoothness and invariance over continuity and returnability. For the original definition, the reader is referred to Nicotra and Garone (2018).

Definition 2. Let ∆ : ˜ D → R p be continuously differentiable and define the set ˜ C = { ( x , v ) ∈ ˜ D | ∆( x , v ) ≥ 0 } . The function ∆ is called a dynamic safety margin (DSM) if the following conditions hold:

<!-- formula-not-decoded -->

<!-- formula-not-decoded -->

<!-- formula-not-decoded -->

where the last property holds ∀ i ∈ { 1 , . . . , p } .

## 2.3 DSM-based CBFs

The following theorem states that DSMs are CBFs for an augmented system consisting of the concatenation of the state x and the virtual reference v

<!-- formula-not-decoded -->

with augmented input ( u , w ) ∈ R m × R l .

Theorem 1. (Freire and Nicotra (2025)). If ∆ : ˜ D → R p is a DSM, then ∆ is a vector-valued CBF for the augmented system (11).

A vector-valued CBF is a group of functions that have the control-sharing property detailed in Xu (2018). This property ensures that the CBF safety filter (4) remains feasible when enforcing multiple CBF conditions simultaneously. In Freire and Nicotra (2025), we use Theorem 1 to construct CBFs using Lyapunov-based DSMs. In this paper, we construct CBFs using the trajectory-based DSM

<!-- formula-not-decoded -->

where c : R n × R l → R p is a continuously differentiable function describing the reference-dependent set of state constraints (i.e., X v = { x ∈ R n | c ( x , v ) ≥ 0 } ) and

Φ( τ, x , v ) is the solution to the prestabilized dynamics (5), given the initial condition x (0) = x and a constant reference v . The following section computes the flow sensitivity Jacobians ∂ Φ /∂ x and ∂ Φ /∂ v , which will appear in the Lie derivatives of ∆( x , v ).

## 3. SENSITIVITY ANALYSIS OF THE PRESTABILIZED DYNAMICS

When there is no ambiguity, we denote by Φ( τ ) = Φ( τ, x , v ) the solution to the initial value problem

<!-- formula-not-decoded -->

By the fundamental theorem of calculus,

<!-- formula-not-decoded -->

Its derivative with respect to the initial condition x is

<!-- formula-not-decoded -->

Let us define the state sensitivity Jacobian

<!-- formula-not-decoded -->

Then, it follows from (15) that S x ( τ ) can be obtained by solving the initial value problem

<!-- formula-not-decoded -->

In a similar manner, we note that the derivative of (14) with respect to the virtual reference v is

<!-- formula-not-decoded -->

By defining the reference sensitivity Jacobian

<!-- formula-not-decoded -->

it follows that we can compute S v ( τ ) as the solution to

<!-- formula-not-decoded -->

subject to the initial condition S v (0) = 0 n × l .

The following Proposition states that, under mild assumptions, the flow sensitivity Jacobians S x ( τ ) and S v ( τ ) converge to values that are known a-priori.

Proposition 1. If ∂f π (¯ x ( v ) , v ) ∂ x is Hurwitz, then ∀ x ∈ D v , the solutions to (17) and (19) satisfy

<!-- formula-not-decoded -->

<!-- formula-not-decoded -->

## Proof. Let

<!-- formula-not-decoded -->

Since A π ( τ ) is continuous and lim τ →∞ A π ( τ ) = ¯ A π , the solution to the initial value problem (17), namely S x ( τ ), exists and is continuous on [0 , ∞ ). Let ¯ P /follows 0 be the unique solution to the Lyapunov equation ¯ A /latticetop π ¯ P + ¯ P ¯ A π + I n = 0. Consider the Lyapunov candidate function

<!-- formula-not-decoded -->

Its derivative along the state sensitivity Jacobian flow is

<!-- formula-not-decoded -->

where Q ( τ ) = -A π ( τ ) /latticetop ¯ P -¯ PA π ( τ ) is symmetric. Since x ∈ D v , Assumption 3 ensures lim τ →∞ Φ( τ ) = ¯ x ( v ). Therefore, lim τ →∞ Q ( τ ) = I n and there exists T &gt; 0 such that Q ( τ ) /follows I n / 2, ∀ τ ≥ T . Therefore,

<!-- formula-not-decoded -->

where ‖ X ‖ F = √ Tr ( X /latticetop X ) is the Frobenius norm of X . Since V ( S x ( T ) ) is bounded and ∂V ( S x ( τ )) ∂τ &lt; 0 , ∀ τ ≥ T , we have

<!-- formula-not-decoded -->

Since ¯ P /follows 0, we conclude that lim τ →∞ S x ( τ ) = 0.

For the second claim, let

<!-- formula-not-decoded -->

and define the error matrix E ( τ ) = S v ( τ )+ ¯ A -1 π ¯ B π . Then,

<!-- formula-not-decoded -->

where the disturbance term D ( τ )= B π ( τ ) -A π ( τ ) ¯ A -1 π ¯ B π satisfies lim τ →∞ D ( τ ) = 0. As before, it follows from continuity of A π ( τ ) and B π ( τ ) that E ( τ ) exists and is unique ∀ τ ∈ [0 , ∞ ).

Evaluating the derivative of (21) along the error term E ( τ ), we obtain

<!-- formula-not-decoded -->

As before, we can show that, ∀ τ ≥ T ,

<!-- formula-not-decoded -->

where we have used the Cauchy-Schwartz inequality. This is sufficient to show that, for all τ ≥ T , V is an ISS Lyapunov function with respect to the disturbance D ( τ ). Since V ( E ( T ) ) is bounded and D ( τ ) is time-vanishing, we conclude lim τ →∞ V ( E ( τ ) ) = 0. Since ¯ P /follows 0, we have lim τ →∞ E ( τ ) = 0, thus lim τ →∞ S v ( τ ) = -¯ A -1 π ¯ B π .

Remark 2. Since the equilibrium point ¯ x ( v ) is asymptotically stable by construction, the only exception to (20) is when the Lyapunov Indirect Method is inconclusive (e.g. f π ( x, v ) = -( x -v ) 2 ). As such, the prestabilizing control law typically ensures the convergence of the flow sensitivity Jacobians.

The following Lemma shows how the state sensitivity Jacobian S x ( τ ) correlates a change in the present state ˙ x to a change in the prestabilized dynamics at a future predicted state Φ( τ ).

Lemma 1. For all x R n , v R l ,

Proof. Given x ∈ R n and v ∈ R l , let

<!-- formula-not-decoded -->

<!-- formula-not-decoded -->

Note that and that

<!-- formula-not-decoded -->

Finally, note that L (0) = f π ( x , v ) = R (0). Since L ( τ ) and R ( τ ) are both subject to the same linear ordinary differential equation with the same initial conditions, we conclude R ( τ ) = L ( τ ), ∀ τ ≥ 0.

## 4. TRAJECTORY BASED DSM-CBF

In this section, we show how to construct CBFs starting from the trajectory-based DSMs featured in Nicotra and Garone (2018). The following theorem constructs a trajectory-based DSM-CBF for the case of a single constraint p = 1. This result trivially generalizes to vectorvalued constraints c : R n × R l → R p by leveraging the control-sharing property from Xu (2018).

Theorem 2. Assume X ⊂ R n and V ⊂ R l are compact. The function

<!-- formula-not-decoded -->

is a DSM if there exists a smooth function τ ∗ : ˜ D → [0 , ∞ ) such that, for all ( x , v ) ∈ ˜ D ,

/negationslash

Proof. To prove property (10a), let ( x , v ) ∈ ˜ C . Then, we have c ( Φ(0) , v ) = c ( x , v ) ≥ 0, which implies x ∈ X v . Also,

<!-- formula-not-decoded -->

<!-- formula-not-decoded -->

which implies ¯ x ( v ) ∈ X v and v ∈ V . This is sufficient to show ˜ C ⊂ ˜ X .

To prove property (10b), note that ˜ C is bounded since ˜ C ⊂ X × V . Thus, we only need to show that ˜ C is closed in R n × R l . This property follows by continuity of ∆( x , v ) and the fact that, by Assumption 4, ˜ C ⊂ ˜ X ⊂ ˜ D , where ˜ X is closed in R n × R l .

To prove property (10c), pick ( x , v ) ∈ ˜ D such that ∆( x , v ) = 0. For convenience, let τ ∗ = τ ∗ ( x , v ). Then,

<!-- formula-not-decoded -->

Multiplying by f π ( x , v ) and using Lemma 1, we obtain

<!-- formula-not-decoded -->

<!-- formula-not-decoded -->

<!-- formula-not-decoded -->

<!-- formula-not-decoded -->

Consider two cases: If for any

τ

∈

[0

, τ

∗

(

x

,

v

τ

∗

(

x

,

v

)

&gt;

0, then

)]. Therefore,

<!-- formula-not-decoded -->

and it follows that

<!-- formula-not-decoded -->

On the other hand, if τ ∗ ( x , v ) = 0, we have ξ (0) = 0 and, necessarily,

<!-- formula-not-decoded -->

Moreover, assume for a contradiction that

<!-- formula-not-decoded -->

Then, there exists δ &gt; 0 such that

<!-- formula-not-decoded -->

contradicting (31). As a result, we conclude

<!-- formula-not-decoded -->

By Theorem 1, the DSM ∆ given in (30) is a CBF for the augmented system (11). Therefore, there exists α ∈ K ∞ such that the optimization-based policy

<!-- formula-not-decoded -->

<!-- formula-not-decoded -->

is feasible for any ( x , v ) ∈ ˜ C and η &gt; 0. The function ρ ( v ) is called a navigation field in the RG literature and plays the same role as κ ( x ): it is a nominal policy for the virtual reference dynamics ˙ v = w . Note that

<!-- formula-not-decoded -->

Therefore, similar to (4), the safety filter (35) is a quadratic program (QP) if U is polyhedral. Unfortunately, (35) is impractical to implement due to two drawbacks: 1) it can be challenging to solve (30) on an infinite horizon τ ∈ [0 , ∞ ) and 2) the existence of a unique minimizer τ ∗ ( x , v ) is a strong assumption that may not hold in practice. These issues are addressed in the following subsections.

## 4.1 Horizon Considerations

Since infinite horizons are numerically intractable, we will consider a finite horizon τ ∈ [0 , T ] and employ invariant terminal set constraints to guarantee invariance for τ &gt; T . The following corollary augments the DSM in Theorem 2 with a terminal DSM.

Proposition 2. Let T &gt; 0 be the horizon length, and let ∆ T : ˜ D → R be a DSM with ˜ C T = { ( x , v ) ∈ ˜ D | ∆ T ( x , v ) ≥ 0 } . If the conditions of Theorem 2 hold with τ ∗ : ˜ D → [0 , T ], then

<!-- formula-not-decoded -->

is a DSM. Moreover, ˜ C T ⊂ ˜ C = { ( x , v ) ∈ ˜ D | ∆( x , v ) ≥ 0 } .

ξ

(

τ

)=

τ

∗

x

(

,

v

)

-

τ

<!-- formula-not-decoded -->

<!-- formula-not-decoded -->

Proof. Properties (10a) and (10b) hold by the same arguments made in the proof of Theorem 2. One can similarly show property (10c) for ∆ 1 .

<!-- formula-not-decoded -->

To prove property (10c) for ∆ 2 , pick ( x , v ) ∈ ˜ D such that ∆ 2 ( x , v ) = ∆ T ( Φ( T ) , v ) = 0. Then,

<!-- formula-not-decoded -->

<!-- formula-not-decoded -->

<!-- formula-not-decoded -->

where we have used Lemma 1 and property (10c) of ∆ T .

To prove the final claim ˜ C T ⊂ ˜ C , let ( x , v ) ∈ ˜ C T . This implies that ∆ T ( x , v ) ≥ 0 and ( x , v ) ∈ ˜ D . By continuity of ∆ T and property (10c), ∆ T ( Φ( τ ) , v ) ≥ 0 for all τ ∈ [0 , ∞ ), implying that ∆ 2 ( x , v ) ≥ 0. Moreover, since x ∈ D v , it follows that ( Φ( τ ) , v ) ∈ ˜ C T ⊂ ˜ X for all τ ∈ [0 , ∞ ). With this, we conclude that ∆ 1 ( x , v ) ≥ 0 and ( x , v ) ∈ ˜ C .

Suitable options for the terminal DSM ∆ T ( x , v ) include the Lyapunov-based DSMs in Freire and Nicotra (2025) or the Sum-of-Squares DSMs in Cotorruelo et al. (2021). Note that, if the prediction horizon T is long enough to ensure ∆ T (Φ( T ) , v ) ≥ 0 , ∀ ( x , v ) ∈ ˜ X v , the terminal set constraint can be omitted. It should also be noted that ∆ T ( x , v ) does not need to share the same prestabilizing controller π used to compute Φ( τ ).

## 4.2 Smoothness Considerations

Theorem 2 and Proposition 2 implicitly assume that, ∀ ( x , v ) ∈ ˜ C , the global minimizer of (30), τ ∗ ( x , v ) is unique. In practice, however, c (Φ( τ ) , v ) may have multiple global minimizers, which causes ∆( x , v ) to not be differentiable. The following proposition states, given a possibly nonsmooth ∆, it is possible to replace (35b) with smooth sufficient conditions.

Proposition 3. Let δ ( τ, x , v ) = c ( Φ( τ ) , v ) and let ∆ be defined as in (37). For any T &gt; 0, if

˙ δ ( τ, x , v , u , w ) ≥ -α ( δ ( τ, x , v ) ) , ∀ τ ∈ [0 , T ] , (42) then, the following inequality holds in the sense of Clarke's generalized Jacobian

<!-- formula-not-decoded -->

Proof. Note that, although ∆ 1 may not be differentiable, it satisfies

<!-- formula-not-decoded -->

By compactness of [0 , T ] and continuity of δ , there exists a set-valued mapping τ ∗ : ˜ D → P ([0 , T ]) such that

<!-- formula-not-decoded -->

With this, the Clarke subdifferentials of ∆ 1 at ( x , v ) are the set-valued map

<!-- formula-not-decoded -->

The Clarke's generalized Jacobian of ∆ 1 ( x , v ), denoted ∇ ∆ 1 ( x , v ), is the convex hull of the Clarke subdifferentials.

We say (43) holds in the sense of Clarke's generalized Jacobian if, ∀ [ H x H v ] ∈ ∇ ∆ 1 ( x , v ),

<!-- formula-not-decoded -->

It is clear that (42) guarantees (47) for all the subdifferentials D ( x , v ) because τ ∗ ( x , v ) ⊂ [0 , T ]. Since ∇ ∆ 1 ( x , v ) is their convex hull, (47) holds for all elements of ∇ ∆ 1 ( x , v ).

## 4.3 Feasibility of the Tractable DSM-CBF Safety Filter

Incorporating the horizon and smoothness considerations, we arrive at a more tractable formulation of the DSM-CBF safety filter

<!-- formula-not-decoded -->

<!-- formula-not-decoded -->

where δ ( τ, x , v ) = c ( Φ( τ ) , v ) ,

<!-- formula-not-decoded -->

<!-- formula-not-decoded -->

and

<!-- formula-not-decoded -->

While (48) has infinite-dimensional constraints, we consider in practice a finite set T ⊂ [0 , T ] and enforce the constraints ∀ τ ∈ T . The set T can be obtained together with Φ( τ ) by using a variable-step solver to solve (13). This can be done to an arbitrary degree of accuracy. As before, (48) is a QP if U is polyhedral. Since it is natural to question if a CBF-QP retains feasibility for all ( x , v ) ∈ ˜ C , the following corollary proves that u = π ( x , v ) and w = 0 is always feasible in (48).

Corollary 1. Let ∆ be defined as in (37) with T ≥ 0. There exists α ∈ K ∞ such that the DSM-CBF safety filter (48) is feasible for all ( x , v ) ∈ ˜ C = { ( x , v ) ∈ ˜ D | ∆( x , v ) ≥ 0 } .

## Proof. Define the set-valued map

<!-- formula-not-decoded -->

<!-- formula-not-decoded -->

For any c ≥ 0 and τ ∈ [0 , T ], the set ˜ C ( c, τ ) is compact in R n × R l . It can also be shown that the set-valued map ˜ C ( · , τ ) is both upper and lower hemicontinuous. Thus, it follows by Berge (1963) maximum theorem that ∀ τ ∈ [0 , T ], the function ˆ α ( · , τ ) is continuous on [0 , ∞ ). Moreover, it is nondecreasing because for any c 1 ≤ c 2 , ˜ C ( c 1 , τ ) ⊂ ˜ C ( c 2 , τ ). Let τ ∈ [0 , T ] be given and pick any ( x , v ) ∈ ˜ C (0 , τ ). Since ∆ 1 ( x , v ) = min τ ∈ [0 ,T ] δ ( τ, x , v ) ≥ 0 and δ ( τ, x , v ) = 0, we must have

<!-- formula-not-decoded -->

This implies ˆ α (0 , τ ) ≤ 0. Therefore, there always exists α ( · , τ ) ∈ K ∞ such that ∀ c ∈ [0 , ∞ ), ˆ α ( c, τ ) ≤ α ( c, τ ). Define

<!-- formula-not-decoded -->

noting that α 1 ( c ) ∈ K ∞ . Since ∆ T is a DSM for π , it is also a CBF and there exists α 2 ∈ K ∞ such that its CBF condition holds. Define now α ( c ) = max i ∈{ 1 , 2 } α i ( c ) ∈ K ∞ . Finally, let ( x , v ) ∈ ˜ C be given and note that π ( x , v ) ∈ U . For any τ ∈ [0 , T ],

<!-- formula-not-decoded -->

<!-- formula-not-decoded -->

Also, since ∆( x , v ) ≥ 0, it follows that ∆ T ( Φ( T ) , v ) ≥ 0 and we have that ( π ( x , v ) , 0 ) ∈ U × R l is such that

Algorithm 1 summarizes the procedure to follow for implementing (48) in practice. Note that the input u is given to the original system, whereas the virtual input w is used to drive the evolution of the virtual reference ˙ v = w .

Remark 3. Although (48) relies on trajectory predictions, it is important to note that those predictions are always computed for a fixed ( x , v ). Since the predictions do not depend on the optimization variables ( u , w ), the computational cost of this approach remains negligible compared to model predictive control.

| Algorithm 1 DSM-CBF Safety Filter                                   |                            |
|---------------------------------------------------------------------|----------------------------|
| Require:                                                            |                            |
| 1: function SafetyFilter ( x , v ) 2: Φ( τ ) ← solve (13) 3: x (17) | /triangleright τ ∈ [0 ,T ] |
| S ( τ ) ← solve                                                     | /triangleright τ ∈ [0 ,T ] |
| 4: S v ( τ ) ← solve (19)                                           | /triangleright τ ∈ ,T      |
| 5: ( u , w ) ← solve (48)                                           | [0 ]                       |
| 6:                                                                  |                            |
| 7:                                                                  |                            |
| return                                                              |                            |
|                                                                     | u , w                      |
| end function                                                        |                            |

## 5. INVERTED PENDULUM ON CART

To showcase the systematic nature of the proposed approach, we apply it to an inverted pendulum on cart with state and input constraints. This example was specifically chosen because it includes several aspects that complicate the design of CBFs, notably: a) input saturation, b) multiple constraints, c) strong nonlinearities, d) high relative degree, and e) non-minimum phase dynamics. The dynamic model of an inverted pendulum on a cart is

<!-- formula-not-decoded -->

where the degrees of freedom q = [ x ; θ ] are the cart position x and the pendulum angle θ , and

<!-- formula-not-decoded -->

where m c = 1kg, m p = 0 . 5kg are the cart and pendulum masses, respectively, L = 0 . 7m is the length of the pendulum, and g = 9 . 81ms -2 is the acceleration of gravity. Letting x = [ q ; ˙ q ], the system is control-affine and can be written as (1). The equilibrium mapping for this system is ¯ x ( v ) = [ v ; π ; 0; 0] and ¯ u ( v ) = 0. We obtain a prestabilizing controller by linearizing the system around the equilibrium point ¯ x ( v ), ¯ u ( v ) and using an LQR. The resulting controller is

<!-- formula-not-decoded -->

with K π = [ -0 . 44 35 . 3 -1 . 4 8 . 0]. Consider the task of moving the system from initial position ¯ x (0) to ¯ x ( r ), with r = 4, while respecting the state and input constraints

<!-- formula-not-decoded -->

<!-- formula-not-decoded -->

with x max = 4 . 5, θ max = π/ 9, and u max = 20. Note that the constraint | θ -π | ≤ θ max prevents the system from exiting the basin of attraction of the LQR.

The reference-dependent state constraint set then becomes X v = { x ∈ R 4 : c ( x , v ) ≥ 0 } , where

<!-- formula-not-decoded -->

The nominal controller κ ( x ) has the form

<!-- formula-not-decoded -->

where K κ = [ -35 150 -20 50]. The navigation field is ρ ( v ) = r -v . We pick a prediction horizon T = 10 seconds and construct a Lyapunov-based terminal DSM ∆ T using the approach in Freire and Nicotra (2025). The class K ∞ function we use for all constraints is α ( c ) = 100 c , and α ( c ) = 400 c for the terminal DSM ∆ T . With this, we follow Algorithm 1 to implement the trajectory-based DSM-CBF filter, with η = 0 . 1, and its performance is shown in Fig. 1.

For comparison, Fig. 1 also shows the simulation traces for the following approaches:

- (1) Nominal : The nominal performance under the nominal controller κ ( x ) is unsafe.
- (2) Lyapunov-based DSM-CBF : Presented in Freire and Nicotra (2025), this approach also uses DSMs to design CBFs. However, their reliance on Lyapunov functions makes the approach overly conservative for this open-loop unstable system.
- (3) ERG : Presented in Nicotra and Garone (2018), this approach relies on the same trajectory-based DSMs

Fig. 1. Simulation of the inverted pendulum on a cart system under different control approaches. Arguably, the proposed Traj DSM-CBF approach achieves the best performance while guaranteeing constraint satisfaction.

<!-- image -->

featured in this paper. However, RG approaches are known to be systematically slower than CBFs.

- (4) Backup CBF : Presented in Chen et al. (2021), this approach can be seen as a precursor to the presented approach since it relies on a 'backup' policy as opposed to a prestabilizing controller. Note that there is no systematic way of finding a backup policy. For this comparison, we used

<!-- formula-not-decoded -->

where the gains are the same as K π , but with the first one zeroed-out. This backup policy attempts to keep the pendulum upright and stationary, regardless of its position x (in prestabilizing terms, it is effectively assigning v ( t ) = x ( t )). While the approach works well, its response is slower than the proposed method. This is is a direct consequence of the fact that the trajectory-based DSM-CBF uses the reference v to parametrize an entire family of backup policies. The added degree of freedom allows for better performance.

## 6. CONCLUSION

This paper presented a systematic approach to design valid CBFs using trajectory predictions of a prestabilized system. Implementation details to achieve a tractable formulation are also provided and studied with rigor. The performance of the proposed approach is illustrated on an inverted pendulum on a cart system and compared to other related constrained control approaches. Future work includes exploring different trajectory prediction techniques and studying the robustness properties of the approach under bounded disturbances.

## REFERENCES

Ames, A.D., Xu, X., Grizzle, J.W., and Tabuada, P. (2017). Control barrier function based quadratic pro-

- grams for safety critical systems. IEEE Transactions on Automatic Control (TAC) , 62(8), 3861-3876.
- Berge, C. (1963). Topological spaces: Including a treatment of multi-valued functions, vector spaces and convexity . Oliver &amp; Boyd.
- Chen, Y., Jankovic, M., Santillo, M., and Ames, A.D. (2021). Backup control barrier functions: Formulation and comparative study. In Proc. IEEE Conference on Decision and Control (CDC) , 6835-6841.
- Choi, J.J., Lee, D., Sreenath, K., Tomlin, C.J., and Herbert, S.L. (2021). Robust control barrier-value functions for safety-critical control. In Proc. IEEE Conference on Decision and Control (CDC) , 6814-6821. IEEE.
- Cotorruelo, A., Hosseinzadeh, M., Ramirez, D.R., Limon, D., and Garone, E. (2021). Reference dependent invariant sets: Sum of squares based computation and applications in constrained control. Automatica , 129, 109614.
- Dai, H., Jiang, C., Zhang, H., and Clark, A. (2024). Verification and synthesis of compatible control Lyapunov and control barrier functions. Proc. of the IEEE Conference on Decision and Control (CDC) , 8178-8185.
- Freire, V., Debarshi, S., and Nicotra, M.M. (2025). Designing control barrier functions for underactuated EulerLagrange systems using dynamic safety margins. IEEE Control Systems Letters (LCSS) .
- Freire, V. and Nicotra, M.M. (2025). Using dynamic safety margins as control barrier functions. To appear: IEEE Transactions on Automatic Control (arXiv preprint arXiv:2404.01445 ).
- Garone, E., Di Cairano, S., and Kolmanovsky, I. (2017). Reference and command governors for systems with constraints: A survey on theory and applications. Automatica , 75, 306-328.
- Harms, M., Kulkarni, M., Khedekar, N., Jacquet, M., and Alexis, K. (2024). Neural control barrier functions for safe navigation. In Proc. IEEE/RSJ International Conference on Intelligent Robots and Systems (IROS) , 10415-10422. IEEE.
- Jang, I. and Kim, H.J. (2024). Safe control for navigation in cluttered space using multiple Lyapunov-based control barrier functions. IEEE Robotics and Automation Letters (RA-L) , 9(3), 2056-2063.
- Lindemann, L., Robey, A., Jiang, L., Das, S., Tu, S., and Matni, N. (2024). Learning robust output control barrier functions from safe expert demonstrations. IEEE Open Journal of Control Systems (OJ-CSYS) , 3, 158-172.
- Nicotra, M.M. and Garone, E. (2018). The explicit reference governor: A general framework for the closedform control of constrained nonlinear systems. IEEE Control Systems Magazine , 38(4), 89-107.
- Shakhesi, E., Katriniok, A., and Heemels, W. (2025). Counterexample-guided synthesis of robust discretetime control barrier functions. IEEE Control Systems Letters (LCSS) .
- Van Wijk, D.E., Coogan, S., Molnar, T.G., Majji, M., and Hobbs, K.L. (2024). Disturbance-robust backup control barrier functions: Safety under uncertain dynamics. IEEE Control Systems Letters (LCSS) .
- Xu, X. (2018). Constrained control of input-output linearizable systems using control sharing barrier functions. Automatica , 87, 195-201.