## Viscosity CBFs: Bridging the Control Barrier Function and Hamilton-Jacobi Reachability Frameworks in Safe Control Theory

Dylan Hirsch, Jaime Fern´ andez Fisac, and Sylvia Herbert

Abstract -Control barrier functions (CBFs) and HamiltonJacobi reachability (HJR) are central frameworks in safe control. Traditionally, these frameworks have been viewed as distinct, with the former focusing on optimally safe controller design and the latter providing sufficient conditions for safety. A previous work introduced the notion of a control barrier value function (CB-VF), which is defined similarly to the other value functions studied in HJR but has certain CBFlike properties. In this work, we proceed the other direction by generalizing CBFs to non-differentiable 'viscosity' CBFs. We show the deep connection between viscosity CBFs and CB-VFs, bridging the CBF and HJR frameworks. Through this bridge, we characterize the viscosity CBFs as precisely those functions which provide CBF-like safety guarantees (control invariance and smooth approach to the boundary). We then further show nice theoretical properties of viscosity CBFs, including their desirable closure under maximum and limit operations. In the process, we also extend CB-VFs to non-exponential antidiscounting and update the corresponding theory for CB-VFs along these lines.

## I. INTRODUCTION

Control barrier functions (CBFs) and Hamilton-Jacobi reachability (HJR) are two primary theoretical frameworks for safe control [1]-[4]. The central notion in HJR is the value function, a scalar function that describes the ability of an optimal controller to achieve a task. The payoff functionals used in HJR (e.g. maximum-over-time, minimumover-time) correspond to various types of tasks (e.g. targetreaching, obstacle-avoidance) [3], [5], [6]. HJR is constructive in that once the payoff is chosen, the value function is uniquely specified. The value functions considered in HJR are usually time-dependent (although time-independent alternatives also exist [7]), are typically non-differentiable, and are characterized by a certain weak ('viscosity') solution to a Hamilton-Jacobi Partial Differential Equation (HJ-PDE).

CBFs are also scalar functions that encode safety information, but they are defined based on the satisfaction of the 'CBF inequality,' a particular partial differential inequality. CBFs provide sufficient conditions to certify not only that a certain set is control-invariant, but that one can avoid

Research reported in this publication was supported by NIBIB of the National Institutes of Health under award number T32EB009380. The content is solely the responsibility of the authors and does not necessarily represent the official views of the National Institutes of Health. This research was 100% financed by Federal Grants.

Dylan Hirsch (corresponding author) and Sylvia Herbert are with the Department of Mechanical and Aerospace Engineering, University of California at San Diego, 9500 Gilman Drive, La Jolla, CA 92093. dhirsch@ucsd.edu, sherbert@ucsd.edu.

Jaime Fisac is with the Department of Mechanical and Aerospace Engineering, Princeton University, Princeton, NJ 08544. jfisac@princeton.edu.

v a lue functions (in the sense of HJR)

CB-VFs a nti-discounted a void v a lue functions :=

viscosity CBFs we a k solutions of CBF inequ a lity :=

- functions which provide the B a rrier Gu a r a ntee =
- time-inv a ri a nt CB-VFs =

(tr a dition a l) CBFs cl a ssic a l solutions of CBF inequ a lity continuously di ff erenti a ble Viscosity CBFs := =

Fig. 1. Graphical abstract: in this work, we bridge Hamilton-Jacobi reachability (HJR) and control barrier function (CBFs). To do so, we extend the work on control barrier value functions (CB-VFs) in [11] and also introduce the notion of a viscosity CBF. A CB-VF is defined similarly to an avoid value function (a value function used in HJR for obstacle-avoidance tasks), except that it is anti-discounted according to a class K function α . A viscosity CBF is similar to a standard CBF, except that the usual CBF inequality is only required to hold in a weak ('viscosity') sense. We show that a viscosity CBF is equivalent to a time-invariant CB-VF. We then show the set of viscosity CBFs is precisely the set of continuous functions which provide the Barrier Guarantee, i.e. certify control invariance of a set and bounds on the speed at which the system can approach the set boundary.

approaching the boundary of this set too quickly. Like Lyapunov functions, CBFs are non-constructive in the sense that there may be many CBFs for a system and there is no single standard approach to obtain a particular one which provides desired safety guarantees. Moreover, CBFs are usually time-independent (although time-varying extensions exist [8]) and continuously differentiable (although notions of non-differentiable CBFs also exist [9], [10]).

In [11], the authors introduce control barrier value functions (CB-VFs) by anti-discounting the payoff for an obstacle-avoidance task. The CB-VF is a value function in the sense of HJR, but it has several CBF-like properties.

In this work, we proceed in the other direction by introducing the notion of a viscosity CBF, a generalization of a CBF that need not be differentiable (and indeed generalizes the non-differentiable CBFs in [9], [10]). Unlike CB-VFs, viscosity CBFs are defined in the spirit of traditional CBFs, i.e. via a solution to a CBF inequality. Whereas traditional CBFs must satisfy this inequality in a classical sense, we only require viscosity CBFs to do so in a certain weak ('viscosity') sense.

We show that the set of viscosity CBFs for a system are in fact precisely the set of time-invariant CB-VFs for the system, theoretically bridging the CBF and HJR frameworks. Through this bridge, we demonstrate that we can characterize the set of all continuous functions (including those which are non-differentiable and even not locally Lipschitz) that can provide CBF-like guarantees (Fig. 1).

We then proceed to further study these viscosity CBFs, including describing how one can synthesize new viscosity CBFs by taking limits of known viscosity CBFs or traditional CBFs. In the process, we also extend the notion of a CBVF beyond exponential anti-discounting to anti-discounting determined by nonlinear class K functions.

We note that in [12], the authors take a viscosity-based approach to control Lyapunov functions. Although related, this work differs mathematically and conceptually from the present one. In particular, the authors use a positive definite function of the state to encourage stabilization to a point, whereas our work uses a class K function of the value to prevent rapid approach of the boundary, fundamentally changing the underlying HJ-PDE. Additionally, the authors in [12] analyze an optimal control problem with a runningcost payoff, whereas we analyze one with a CB-VF payoff to make the connection between HJR and CBFs.

## II. PROBLEM SETTING AND PRELIMINARIES

In this work we consider a dynamical system

<!-- formula-not-decoded -->

where f : R n ×U → R n is Lipschitz, with the set of allowed control input values U ⊂ R n assumed compact. Here, x is the system's state and u is the control input (we use the boldface to distinguish the state trajectory x and input signal u from a state value x ∈ R n and input value u ∈ U ).

We will denote the set of measurable functions u : R ≥ 0 → U by U , representing the allowed control signals.

Definition 1 (Class K ; Definition 4.2 in Chapter 4.4 of [13]) . A function α : R ≥ 0 → R ≥ 0 is class K if it is continuous, is strictly increasing, and satisfies α (0) = 0 .

Definition 2 (Class KL ; Definition 4.3 in Chapter 4.4 of [13]) . A function β : R ≥ 0 × R ≥ 0 → R ≥ 0 is class KL if it is continuous and (i) β ( · , t ) is class K for each t ≥ 0 , (ii) β ( r, · ) is non-increasing for each r ≥ 0 , and (iii) β ( r, t ) → 0 as t →∞ for each r ≥ 0 .

By Lemma 4.4 of [13], if a class K function α is locally Lipschitz, we can associate it with a class KL function β α by for each r ≥ 0 defining β α ( r, · ) to be the solution of the initial value problem ˙ y = -α ( y ) , y (0) = r .

Definition 3 (Control Invariant Set) . A set S ⊆ R n is control invariant (with respect to f ) if for each x ∈ S there is a u ∈ U such that x u x ( t ) ∈ S for all t ≥ 0 .

Definition 4 (Control Barrier Function) . A function h : R n → R is a control barrier function with respect to a class K function α if it is continuously differentiable and

<!-- formula-not-decoded -->

<!-- formula-not-decoded -->

Remark 1. Some definitions of CBFs do not impose demands on the behavior of the system outside of the control-invariant set, while others require that if the system begins outside of this set it can return sufficiently quickly toward the boundary. For ease of exposition, we adopt the former definition (hence we only require that the CBF inequality holds when h ( x ) &gt; 0 ). We note, however, that analogous results can also be shown in a similar fashion for the latter definition (which will be saved for future work).

## III. THE BARRIER GUARANTEE

While CBFs can be used to certify control-invariance of a set, if one is solely concerned with this objective, Nagumo's theorem can be used instead. The true upsell of CBFs is their additional guarantees, in particular bounding the rate at which a system can approach the boundary of a safe set (in some respects, it is this property that enables safety filter design using CBFs). Motivated by this idea, we introduce the notion of a Barrier Guarantee (c.f. Definition 4 in [9]).

Definition 5 (Barrier Guarantee) . A continuous function B : R n → R provides the Barrier Guarantee with respect to a locally Lipschitz class K function α if for each θ ∈ [0 , 1) and each x ∈ R n satisfying B ( x ) &gt; 0 , there is a u ∈ U such that for all t ≥ 0 we have

<!-- formula-not-decoded -->

Remark 2. To motivate the preceding definition, suppose as in Theorem 2 of [2], we have a (traditional) CBF h : R n → R and that we can find a Lipschitz feedback law u = k ( x ) such that for each x ∈ R n we have

<!-- formula-not-decoded -->

Let x be some trajectory of the closed loop system. Recognizing that the left-hand-side of the above inequality is simply d dt h ( x ( t )) , the comparison principle then gives

<!-- formula-not-decoded -->

for all t ≥ 0 , where x := x (0) . The above inequality is almost identical to (2) with B = h , except that in (2) the multiplier θ appears for technical reasons related to the fact that a safe Lipschitz controller for a CBF may not exist.

For an example when a safe Lipschitz controller does not exist, consider the CBF h ( x ) = 1 -x 2 for the scalar system ˙ x = u with the admissible control set U = {-1 , +1 } . There are only two Lipschitz controllers: k ( x ) ≡ +1 and k ( x ) ≡ -1 , neither of which is safe.

If a function B provides the Barrier Guarantee, it immediately implies that the strict zero super-level set S := { x | B ( x ) &gt; 0 } of B is control invariant. (Note that we consider throughout this work the strict zero super-level because the existence of even a traditional CBF does not in fact guarantee control-invariance of the non-strict zero super-level set without additional assumptions, e.g. controlaffine dynamics and convexity of U ; see Appendix C for a counter-example.) Beyond just control invariance, however, as demonstrated in Remark 2, the Barrier Guarantee provides a CBF-like bound on how fast the system can approach the boundary ∂ S of this set whenever it is initialized within S .

While any CBF provides the Barrier Guarantee, the continuous differentiability requirements of traditional CBFs are stronger than needed to guarantee this property holds. Our primary goal in this work will be to characterize all those functions which provide this guarantee. To do so, we will introduce a certain notion of a non-differentiable CBF, slightly more general than that introduced in [9] and having several nice theoretical properties. It will turn out that it is precisely these more general 'viscosity' CBFs which provide the Barrier Guarantee. To establish this fact, we will need to elucidate the deep connection between CBFs and the value functions of HJR. In some sense, characterizing those functions which provide the Barrier Guarantee then serves as an example of the utility of bridging CBF and HJR theory.

The following easily verified fact will be of later use.

Lemma 1. Let B : R n → R be continuous and α be locally Lipschitz class K . Then B provides the Barrier Guarantee w.r.t. α if and only if max { 0 , B } provides the Barrier Guarantee w.r.t. α .

## IV. VISCOSITY CBFS AND CONTROL BARRIER VALUE FUNCTIONS

## A. Viscosity CBFs

To characterize the functions which provide the Barrier Guarantee and also to connect CBFs and HJR, we introduce the key mathematical object of this work: the viscosity CBF.

Definition 6 (Viscosity CBF) . A continuous function h : R n → R is a viscosity CBF with respect to a class K function α if it is continuous and for each x ∈ R n , the inequality

<!-- formula-not-decoded -->

holds in the viscosity sense at each x ∈ R n for which h ( x ) &gt; 0 . By 'in the viscosity sense, ' we mean that for any continuously differentiable function φ : R n → R such that h -φ has a local maximum at x , we have

<!-- formula-not-decoded -->

('In the viscosity sense' is standard terminology in PDE literature; see e.g. Chapter II.5.5 in [14].)

Example 1. Consider the scalar system with ˙ x = x + x + x 3 1+ | x | u , with admissible control set U = [ -1 , +1] . Let h : R → R be the signed distance function to an unsafe set ( -∞ , -1] ∪ [+1 , + ∞ ) , i.e. h ( x ) = 1 -| x | .

This function is not a CBF as it is not differentiable at 0 , but we show it is a viscosity CBF with respect to α ( r ) = r . One can check directly that (3) holds in a classical sense at each x ∈ ( -1 , 0) ∪ (0 , +1) , and thus it also holds in a viscosity sense here (Lemmas II.1.7(a) and II.1.8(b) in [14]).

At the point x = 0 on the other hand, it is immediate that (4) holds for every continuously differentiable φ : R → R , and thus it certainly holds for such φ for which h -φ has a local maximum at 0 .

Note that if a viscosity CBF happens to be continuously differentiable, then it is also a traditional CBF (see Lemmas II.1.7(a) and II.1.8(b) in [14]). Similarly, all traditional CBFs are viscosity CBFs (see Proposition II.1.3(b) in [14]). It will often be most convenient to work with non-negative viscosity CBFs. Doing so is made simple thanks to the following lemma, whose proof is trivial.

Lemma 2. Let h : R n → R be continuous and α be class K . Then h is a viscosity CBF w.r.t. α if and only if max { 0 , h } is a viscosity CBF w.r.t. α .

Viscosity CBFs are a particular way of generalizing traditional CBFs to non-differentiable functions. They are slightly more general than the non-smooth CBFs introduced in [9], permitting even CBFs that are not locally Lipschitz. The purpose of allowing for such exotic non-differentiable CBFs is not out of mathematical interest but for their useful theoretical properties and direct connection to HJR and the Barrier Guarantee. To establish these properties and connections, we must introduce a certain kind of value function from HJR.

## B. Viscosity solutions of Hamilton Jacobi Partial Differential Equations

Before proceeding, we briefly review the notion of viscosity solutions. A viscosity solution is a specific type of weak solution of a HJ-PDE which need not be continuously differentiable (often too restrictive for existence) but satisfies more than just differentiability almost everywhere (often too loose for uniqueness).

Definition 7 (Viscosity solution) . Let Ω ⊆ R m be open, let M ⊆ R be closed, and let F : Ω × M × R m → R be continuous. Consider the HJ-PDE

<!-- formula-not-decoded -->

A continuous function µ : Ω → M is a

- viscosity sub-solution of this PDE if for each continuously differentiable function φ : Ω → R , we have F ( z 0 , µ ( z 0 ) , Dφ ( z 0 )) ≤ 0 for any z 0 ∈ Ω at which µ -φ has a local maximum.
- viscosity super-solution of this PDE if for each continuously differentiable function φ : Ω → R , we have F ( z 0 , µ ( z 0 ) , Dφ ( z 0 )) ≥ 0 for any z 0 ∈ Ω at which µ -φ has a local minimum.
- viscosity solution of this PDE if it is both a viscosity sub-solution and super-solution.

Notationally, for the time-dependent PDEs considered in this work, it will be the case that µ = v , z = ( x, T ) , m = n + 1 , Ω = R n × (0 , ∞ ) , M = R ≥ 0 , and D = ( ∇ , ∂ ∂T ) . For the time-independent PDEs considered, it will be the case that µ = h , z = x , m = n , Ω = R n , M = R ≥ 0 , and D = ∇ . For a more thorough introduction to viscosity solutions of HJ-PDEs, we refer the reader to [14]-[16].

When we work in particular with non-negative viscosity CBFs, we get the following useful characterization.

Lemma 3. Let h : R n → R ≥ 0 be continuous and α be class K . Define the Hamiltonian H α : R n × R ≥ 0 × R n → R by

<!-- formula-not-decoded -->

Then h is a viscosity CBF w.r.t. α if and only if it is a viscosity sub-solution of -H α ( x, h, ∇ h ) = 0 .

Remark 3. In the above HJ-PDE, the negative signs must be retained as negating both sides of an HJ-PDE can result in unwanted changes to its viscosity sub/super-solutions.

Proof. The reverse implication is immediate, so suppose that h is a viscosity CBF w.r.t. α . Fix x 0 ∈ R n , and let φ : R n → R be a continuously differentiable function such that h -φ has a local maximum at x 0 . We wish to show that

<!-- formula-not-decoded -->

There are two cases: either h ( x 0 ) &gt; 0 or h ( x 0 ) = 0 . In the first case, (6) follows directly from the definition of a viscosity CBF. In the second case, since h is non-negative, it follows that h has a minimum at x 0 . But since φ -h has a local minumum at x 0 , it follows that φ has a local minimum at x 0 as well. Thus ∇ φ ( x 0 ) = 0 , so (6) follows.

## C. Avoid value functions and control barrier value functions

In HJR, the standard value function used for obstacle avoidance tasks is the 'avoid' value function. Given a continuous function g : R n → R , the avoid function V : R n × R ≥ 0 → R corresponding to g is defined by

<!-- formula-not-decoded -->

In applications, we choose g to be non-positive within and only within the obstacle so that V ( x, T ) &gt; 0 if and only if the system, initialized at x , can avoid the obstacle until time T . We refer to such a g as an 'immediate safety function.'

In [11], the authors define a time-varying value function having some CBF-like properties, which they call a control barrier value function (CB-VF). A CB-VF is similar to an avoid value function except that it is anti-discounted according to a function α . As the previous work only considers exponential anti-discounting, to fully capture the striking connection between CBFs and HJR, we must extend the CB-VF definition to more general anti-discounting, i.e. as specified by a locally Lipschitz class K function α (where exponential anti-discounting corresponds to α ( r ) = γr ).

Given g : R n → R ≥ 0 continuous and α locally Lipschitz class K , we define the CB-VF v : R n × R ≥ 0 → R ≥ 0 corresponding to h and α implicitly by

<!-- formula-not-decoded -->

Note that for each x ∈ R n and T ≥ 0 , (7) indeed has a unique solution v ( x, T ) since

<!-- formula-not-decoded -->

It can be seen from (7) that if there is a control signal u for which g ( x u x ( t )) ≥ β α ( g ( x ) , t ) for all t ∈ [0 , T ] ,

(

<!-- image -->

,

) =

(

)

(

,

) &lt;

(

)

Fig. 2. Cartoon showing the level sets of an example immediate safety function g : R 2 → R . Given a locally Lipschitz class K function α , a time horizon T , and an initial state x for which g ( x ) &gt; 0 , the value v ( x, T ) of the corresponding CB-VF is equal to the initial immediate safety g ( x ) when the control can keep the immediate safety value g ( x u x ( t )) along the trajectory above or arbitrarily close to β α ( g ( x ) , t ) at all times t ∈ [0 , T ] . Otherwise, the CB-VF value is strictly less than the initial immediate safety.

then v ( x, T ) = g ( x ) . More explicitly, the CB-VF v ( x, T ) is equal to the initial immediate safety g ( x ) when there is a control signal u which can prevent the immediate safety along the trajectory g ( x u x ( t )) from decaying too quickly, where α determines the allowed rate of decay (Fig. 2).

## V. MAIN THEORETICAL RESULTS

The first theorem characterizes a CB-VF as the viscosity solution of a certain HJ-PDE. This is essentially a modification of Theorem 3 in [11] for nonlinear α .

Theorem 1. Let g : R n → R ≥ 0 be continuous and let α be locally Lipschitz class K . Define the Hamiltonian H α : R n × R ≥ 0 × R n → R by (5) . The CB-VF v : R n × R ≥ 0 → R ≥ 0 corresponding to g and α is continuous and is the unique viscosity solution of the HJ-PDE

<!-- formula-not-decoded -->

for which the initial condition v ( · , 0) ≡ h ( · ) holds.

<!-- formula-not-decoded -->

Remark 4. It is standard in HJR to let t ≤ 0 be the initial time, let 0 be the final time, and derive an analogue of (8) via dynamic programming in t . In this work, it is more clear and convenient to let 0 be the initial time, let T ≥ 0 be the final time, and do dynamic programming in T . It is for this reason that we consider an initial-value problem rather than a terminal-value problem. We refer the reader to Chapters 10.1 and 10.3 of [15] for more on interchanging between such problems.

The following result establishes an equivalence between non-negative viscosity CBFs, time-invariant CB-VFs, and non-negative functions which provide the Barrier Guarantee. In particular, all these functions are viscosity solutions of a certain time-independent HJ-PDE.

Theorem 2. Let α be locally Lipschitz class K , and let h : R n → R ≥ 0 be continuous. The following are equivalent:

- 1) h is a viscosity CBF with respect to α .
- 2) h is a viscosity solution of the HJ-PDE

<!-- formula-not-decoded -->

where the Hamiltonian H α : R n × R ≥ 0 × R n → R is given by (5) .

- 3) The CB-VF v corresponding to h and α is timeinvariant, i.e. v ( · , T ) ≡ h ( · ) for each T ≥ 0 .
- 4) h provides the Barrier Guarantee with respect to α .

Proof. See Appendix B.

Let us make explicit the meaning of the equivalence between 1 and 3. Recall that the CB-VF v is always defined with respect to a chosen immediate safety function (typically called g , but in the above theorem it is h ). The implication 1 → 3 indicates that if we choose the immediate safety function h to be a viscosity CBF, the corresponding CB-VF will be time-invariant, i.e. always equal to h . The implication 3 → 1 indicates that if we happen to choose an immediate safety function h for which the corresponding CB-VF is time-invariant, then h must be a viscosity CBF.

For completeness, we provide the following corollary, which does not assume that h is non-negative.

Corollary 1. Let α be locally Lipschitz class K , and let h : R n → R be continuous. Then h is a viscosity CBF w.r.t. α iff it provides the Barrier Guarantee w.r.t. α .

Proof. Immediate from Theorem 2 and Lemmas 1 and 2.

Note that in the above corollary, no mention of value functions were made, but arriving at this conclusion required us to leverage the relationship between CBFs and HJR. In this sense, the above result is an example of the utility of connecting these two theoretical frameworks.

Corollary 2. Let h : R n → R ≥ 0 be continuous. The avoid value function V : R n × R ≥ 0 → R ≥ 0 corresponding to h is time-invariant iff h is a viscosity CBF with respect to all locally Lipschitz class K functions α .

Proof. It can be checked similarly to steps ( 3 → 4 ) and ( 4 → 3 ) in Appendix B that V ( · , T ) ≡ h ( · ) for all T ≥ 0 iff V provides the Barrier Guarantee with respect to all locally Lipschitz class K functions α . Theorem 2 then gives the desired result.

## VI. SYNTHESIS PROPERTIES OF VISCOSITY CBFS

Now that we have established the theoretical utility of viscosity CBFs in Theorem 2, let us investigate some of their properties. Lemma 3 established an equivalence between viscosity CBFs and viscosity sub-solutions of a certain HJPDE. This equivalence allows us to apply the remarkable array of theory developed for viscosity solutions of HJ-PDEs directly to viscosity CBFs. As an example of how one can leverage this body of work, we briefly demonstrate ways to synthesize new viscosity CBFs from known viscosity CBFs (or traditional CBFs) via this approach.

Theorem 3. Let h 1 , h 2 : R n → R be viscosity CBFs with respect to a class K function α . Then max { h 1 , h 2 } is also a viscosity CBF with respect to α .

Proof. This result follows from Lemma 3 and Proposition II.2.1(a) in [14].

Theorem 4. Let h 1 , h 2 , · · · : R n → R be a sequence of viscosity CBFs with respect to a class K function α . Suppose h i → h locally uniformly, where h : R n → R ≥ 0 . Then h is also a viscosity CBF with respect to α .

Proof. Note that h is automatically continuous by the Uniform Limit Theorem. The result then follows from Lemma 3 and Proposition II.2.2 in [14].

Remark 5. The above result also holds if the dynamics themselves change, i.e. h i is a viscosity CBF for the dynamics ˙ x = f i ( x , u ) , so long as the f i also converge locally uniformly to f . See Proposition II.2.2 in [14] for details.

Remark 6. The theorems in this section assume we have already been given viscosity (or traditional) CBFs when synthesizing new ones. One may wonder if there is a computational technique to synthesize a viscosity CBF from scratch. Indeed, [11] reasons that if a CB-VF v corresponding to some immediate safety function g converges as T →∞ , i.e. v ( · , T ) → h ( · ) , and the limit h happens to be continuously differentiable, then one can expect h to be a valid CBF for the largest control-invariant subset within the zero super-level set of g . This work suggests that even when not differentiable, one can expect h will be a viscosity CBF for this subset. Future work is required to make this approach precise.

## VII. CONCLUSION

We previously noted that a viscosity solution of a partial differential equation is useful because it does not require continuous differentiability (can be too restrictive for existence) but requires more than differentiability almost everywhere (can be too loose for uniqueness). In the same vein, a viscosity CBF is useful because it does not require continuous differentiability, which can be too restrictive for existence (e.g. no CBF can certify control invariance of the open unit square), but requires more than the CBF inequality holding almost everywhere (which is too loose for safety guarantees). While this symmetry may at first seem like a coincidence, it is instead a consequence of the fact that viscosity CBFs are indeed HJR value functions (namely time-invariant CB-VFs).

This realization opens up a new approach to CBF theory by characterizing a CBF (in this more generalized sense) as the viscosity sub-solution of an invariant HJ-PDE, which immediately allows us to use the theory developed for these PDEs to obtain theoretical guarantees on viscosity CBFs. With this connection in mind, the authors expect that advancements in the theory of HJR will be useful for extending the theory of CBFs and vice-versa.

## A. Proof of Theorem 1

Throughout this part of the appendix, we fix an arbitrary locally Lipschitz class K function α : R ≥ 0 → R ≥ 0 and an arbitrary continuous function g : R n → R ≥ 0 . We define H α : R n × R ≥ 0 × R n → R by (5) and define H : R n × R n → R by H ( x, λ ) = max u ∈U λ · f ( x, u ) .

Additionally, for each r ≥ 0 , we let [0 , b α ( r )) be the maximal interval of existence of the initial value problem

<!-- formula-not-decoded -->

and set A α = { ( r, t ) ∈ R ≥ 0 × R ≥ 0 | t ∈ [0 , b α ( r )) } . We define κ α : A α → R ≥ 0 by for each r ≥ 0 setting κ α ( r, · ) : [0 , b α ( r )) → R ≥ 0 to be the solution to (10).

<!-- formula-not-decoded -->

Proof. It follows immediately from the definition of β α that ∂ ∂t β α ( r, t ) = -α ( β α ( r, t )) for all r &gt; 0 and t ≥ 0 (where for t = 0 the partial derivative is understood to be one-sided).

Now fix some particular r, t &gt; 0 . For each τ &gt; 0 ,

<!-- formula-not-decoded -->

Thus

<!-- formula-not-decoded -->

Next, notice that for each τ ∈ (0 , min { b α ( r ) , t } ) ,

<!-- formula-not-decoded -->

Thus

<!-- formula-not-decoded -->

The desired result follows from noticing these these limits are in fact the left and right derivatives of β α ( r, t ) w.r.t. r .

<!-- formula-not-decoded -->

Proof. The result for the partial derivative w.r.t. t follows directly from the definition of κ α . Also by definition of κ α , for all ( ρ, τ ) ∈ A α we have β α ( κ α ( ρ, τ ) , τ ) = ρ . Then by the inverse function theorem and Lemma 4,

<!-- formula-not-decoded -->

Lemma 6. Let R &gt; 0 . There is an L &gt; 0 such that β α ( r, t ) ≥ re -Lt for all r ∈ [0 , R ] and t ≥ 0 .

Proof. Because α is locally Lipschitz, we can choose an L &gt; 0 such that α ( r ) ≤ Lr for each r ∈ [0 , R ] . Fix a particular r ∈ [0 , R ] . Recall that β α ( r, · ) is the solution to

## APPENDIX

the ODE ˙ y = -α ( y ) corresponding to the initial condition y (0) = r . For all t ≥ 0 , we have β α ( r, t ) ≤ R so that

<!-- formula-not-decoded -->

The result then follows from the comparison principle.

Lemma 7. Suppose that v, w : R n × R ≥ 0 → R ≥ 0 are continuous and satisfy β α ( v ( x, T ) , T ) = w ( x, T ) for all ( x, T ) ∈ R n × R ≥ 0 . Then w is a viscosity solution of

<!-- formula-not-decoded -->

iff v is viscosity solution of (8) .

Proof. ( = ⇒ ) Suppose that w is a viscosity solution of (11). We first establish that v is a viscosity sub-solution of (8). Let ( x 0 , T 0 ) ∈ R n × (0 , ∞ ) . Suppose that φ : R n × (0 , ∞ ) → R is continuously differentiable and v -φ has a local maximum at ( x 0 , T 0 ) . Without loss of generality we may assume φ ( x 0 , T 0 ) = v ( x 0 , T 0 ) . We wish to show that

<!-- formula-not-decoded -->

First suppose v ( x 0 , T 0 ) = φ ( x 0 , T 0 ) = 0 . Since v -φ has a local maximum at ( x 0 , T 0 ) and since v is non-negative it follows that φ has a local minimum at ( x 0 , T 0 ) . Thus ∂ ∂T φ ( x 0 , T 0 ) = 0 and ∇ φ ( x 0 , T 0 ) = 0 , so (12) holds.

Next suppose that v ( x 0 , T 0 ) = φ ( x 0 , T 0 ) &gt; 0 . Choose an open neighborhood N ⊆ R n × (0 , ∞ ) of ( x 0 , T 0 ) such that φ &gt; 0 everywhere in N . Let ψ : N → R ≥ 0 be defined by ψ ( x, T ) = β α ( φ ( x, T ) , T ) . Then ψ ( x 0 , T 0 ) = β α ( v ( x 0 , T 0 ) , T 0 ) = w ( x 0 , T 0 ) and w |N ψ has a local maximum at ( x 0 , T 0 ) . Since w |N is a viscosity solution of (11) on N , it follows that

<!-- formula-not-decoded -->

For convenience, let a = ∂ ∂t β α ( φ ( x 0 , T 0 ) , T 0 ) and let b = ∂ ∂r β α ( φ ( x 0 , T 0 ) , T 0 ) so that

<!-- formula-not-decoded -->

Since a/b = -α ( φ ( x 0 , T 0 )) with b &gt; 0 and since β α ( · , T 0 ) is strictly increasing, the above inequality implies (12).

We next establish that v is a viscosity super-solution of (12). Let ( x 0 , T 0 ) ∈ R n . Suppose that φ : R n × (0 , ∞ ) → R is continuously differentiable and v -φ has a local minimum at ( x 0 , T 0 ) . Without loss of generality we may assume φ ( x 0 , T 0 ) = v ( x 0 , T 0 ) . We wish to show that

<!-- formula-not-decoded -->

First suppose v ( x 0 , T 0 ) = φ ( x 0 , T 0 ) = 0 . Since v -φ has a local minimum at ( x 0 , T 0 ) , we can choose some compact neighborhood N ⊆ R n × (0 , ∞ ) of ( x 0 , T 0 ) such that v ≥ φ in N . Let R = max ( x,T ) ∈N v ( x, T ) + 1 . By Lemma 6, we can choose an L &gt; 0 such that β α ( r, t ) ≥ re -Lt for each r ∈ [0 , R ] and t ≥ 0 . Moreover, since N is compact, we can choose an S ∈ R such that S &gt; T for each ( x, T ) ∈ N . Setting c = e -LS , it follows that w ( x, T ) -cφ ( x, T ) = β ( v ( x, T ) , T ) -cφ ( x, T ) ≥ 0 for each ( x, T ) ∈ N . Since w ( x 0 , T 0 ) -cφ ( x 0 , T 0 ) = 0 , it follows that w -cφ has a local minimum at ( x 0 , T 0 ) . Eq. (13) then follows from

<!-- formula-not-decoded -->

The case v ( x 0 , T 0 ) = φ ( x 0 , T 0 ) &gt; 0 follows analogously to the same case in the sub-solution proof.

( ⇐ = ) Suppose that v is a viscosity solution of (8). We first establish that w is a viscosity sub-solution of (11). Let ( x, T ) ∈ R n × (0 , ∞ ) . Suppose that φ : R n × (0 , ∞ ) → R is continuously differentiable and w -φ has a local maximum at ( x 0 , T 0 ) . Without loss of generality we may assume φ ( x 0 , T 0 ) = v ( x 0 , T 0 ) . We wish to show that

<!-- formula-not-decoded -->

First suppose w ( x 0 , T 0 ) = φ ( x 0 , T 0 ) = 0 . Since w -φ has a local maximum at ( x 0 , T 0 ) and since w is nonnegative it follows that φ has a local minimum at ( x 0 , T 0 ) . Thus ∂ ∂T φ ( x 0 , T 0 ) = 0 and ∇ φ ( x 0 , T 0 ) = 0 , so (14) holds.

Next suppose that w ( x 0 , T 0 ) = φ ( x 0 , T 0 ) &gt; 0 . Choose a neighborhood N ⊆ R n × (0 , ∞ ) of ( x 0 , T 0 ) such that ( φ ( x, T ) , T ) ∈ A α and φ ( x, T ) &gt; 0 for each ( x, T ) ∈ N . Let ψ : N → R ≥ 0 be defined by ψ ( x, T ) = κ α ( φ ( x, T ) , T ) . Then ψ ( x 0 , T 0 ) = κ α ( w ( x 0 , T 0 ) , T 0 ) = v ( x 0 , T 0 ) and v |N ψ has a local maximum at ( x 0 , T 0 ) . Since v |N is a viscosity solution of (8) on N , it follows that

<!-- formula-not-decoded -->

For convenience, let a = ∂ ∂t κ α ( φ ( x 0 , T 0 ) , T 0 ) and let b = ∂ ∂r κ α ( φ ( x 0 , T 0 ) , T 0 ) so that

<!-- formula-not-decoded -->

Since a = α ( κ α ( φ ( x 0 , T 0 ) , T 0 ) and b &gt; 0 by Lemma 5, the above inequality implies (14).

We next establish that w is a viscosity super-solution of (11). Let ( x 0 , T 0 ) ∈ R n × (0 , ∞ ) . Suppose that φ : R n × (0 , ∞ ) → R is continuously differentiable and w -φ has a local minimum at ( x 0 , T 0 ) . Without loss of generality we may assume φ ( x 0 , T 0 ) = v ( x 0 , T 0 ) . We wish to show that

<!-- formula-not-decoded -->

First suppose w ( x 0 , T 0 ) = φ ( x 0 , T 0 ) = 0 . Since v ( x 0 , T 0 ) = 0 and v ≥ w and since w -φ has a local minimum at ( x 0 , T 0 ) , it follows that v -φ has a local minimum at ( x 0 , T 0 ) . Thus

<!-- formula-not-decoded -->

But the above implies (15). The case w ( x 0 , T 0 ) = φ ( x 0 , T 0 ) &gt; 0 is similar to the sub-solution argument.

Lemma 8. Let g : R n → R ≥ 0 be continuous, and let α : R ≥ 0 → R ≥ 0 be locally Lipschitz class K . Define w : R n × R ≥ 0 → R ≥ 0 by

<!-- formula-not-decoded -->

Then w is continuous and is the unique viscosity solution of (11) .

Proof. Continuity of w follows from observing

<!-- formula-not-decoded -->

and recalling that β α is continuous and the dynamics f are Lipschitz. That w is a viscosity solution of (11) is a standard dynamic programming argument, see e.g. [6]. The uniqueness result is a straightforward extension of Theorems III.3.12 and III.3.15 in [14]. (See [17] for another approach under slightly different assumptions.)

Proof of Theorem 1. Let w be as in Lemma 8. For each ( x, T ) ∈ R n × (0 , ∞ ) , we have v ( x, T ) = κ α ( w ( x, T ) , T ) . As w and κ α are continuous, v is also. The result follows from Lemmas 7 and 8.

## B. Proof of Theorem 2

Proof of Theorem 2. ( 1 → 2 ) Suppose h is a viscosity CBF w.r.t. α . Let φ : R n → R be continuously differentiable, and suppose h -φ has a local maximum at x 0 ∈ R n . Then H α ( x 0 , h ( x 0 ) , ∇ φ ( x 0 )) ≥ 0 by Lemma 3. Thus -min { H α ( x 0 , h ( x 0 ) , ∇ φ ( x 0 )) , 0 } ≤ 0 . On the other hand, for any continuously differentiable φ : R n → R and any x 0 ∈ R n , we trivially have -min { H α ( x 0 , h ( x 0 ) , ∇ φ ( x 0 )) , 0 } ≥ 0 .

( 2 → 1 ) Suppose h is a viscosity solution of (9). Let φ : R n → R be continuously differentiable, and suppose h -φ has a local maximum at x 0 ∈ R n . Then -min { H α ( x 0 , h ( x 0 ) , ∇ φ ( x 0 )) , 0 } ≤ 0 , so that H α ( x 0 , h ( x 0 ) , ∇ φ ( x 0 )) ≥ 0 .

( 2 → 3 ) Suppose h is a viscosity solution of (7). Define ˜ v : R n × R ≥ 0 → R by ˜ v ( x, T ) = h ( x ) . It follows that h is also viscosity solution of (8). Then v = ˜ v by Theorem 1.

( 3 → 2 ) Immediate from Theorem 1.

( 3 → 4 ) Suppose that for each T ≥ 0 , we have v ( · , T ) ≡ h ( · ) . Then for each x ∈ R n , we in particular have

<!-- formula-not-decoded -->

Now, fix some x ∈ R n and θ ∈ [0 , 1) . We construct a control signal u ∗ ∈ U recursively. Set x 0 = x and θ 0 = θ . Having defined x n ∈ R n and θ n ∈ [0 , 1) , choose u n +1 ∈ U and θ n +1 ∈ [0 , 1) such that β α ( θ n h ( x n ) , 1) ≤ min t ∈ [0 , 1] β α ( θ n +1 h ( x u n +1 x n ( t )) , 1 -t ) . It follows that for each t ∈ [0 , 1] , β α ( β α ( θ n h ( x n ) , t ) , 1 -t ) = β α ( θ n h ( x n ) , 1) ≤ β α ( θ n +1 h ( x u n +1 x n ( t )) , 1 -t ) . Thus

<!-- formula-not-decoded -->

Now set x n +1 = x u n +1 x n (1) . We define u ∈ U by setting u ( · ) = u i ( · ) on [ i -1 , i ) for each i ∈ N . Thus for each n = 0 , 1 , . . . and t ∈ [0 , 1] we have

<!-- formula-not-decoded -->

We show by induction that for each k = 0 , 1 , . . . we also have β α ( θh ( x ) , k + t ) ≤ θ k +1 h ( x u ∗ x ( k + t )) for all t ∈ [0 , 1] , from which the result follows. Indeed, the base case is immediate from (16)-(17). Now, suppose the induction hypothesis holds for k . Then by (17), β α ( θh ( x ) , k + 1) ≤ θ k +1 h ( x k +1 ) so that for all t ∈ [0 , 1] ,

<!-- formula-not-decoded -->

( 4 → 3 ) Suppose g provides the Barrier Guarantee w.r.t. α . Fix some particular θ ∈ [0 , 1) and x ∈ R n , and choose a u ∈ U such that β α ( θh ( x ) , t ) ≤ h ( x u x ( t )) for all t ≥ 0 . Then β α ( θh ( x ) , T ) = β α ( β α ( θh ( x ) , t ) , T -t ) ≤ β α ( h ( x u x ( t )) , T -t ) for all t ≥ 0 and T ≥ t , . Thus β α ( θh ( x ) , T ) ≤ sup ˜ u ∈ U min t ∈ [0 ,T ] β α ( h ( x ˜ u x ( t )) , T -t ) ≤ β α ( h ( x ) , T ) for all T ≥ 0 . Letting θ → 1 shows that β α ( h ( x ) , T ) = sup ˜ u ∈ U min t ∈ [0 ,T ] β α ( h ( x ˜ u x ( t )) , T -t ) . But then v ( · , T ) ≡ h ( · ) for each T ≥ 0 .

## C. Control Invariance Counter-Example

It is not true that existence of a CBF h generally certifies control-invariance of its non-strict zero super-level set S ≥ 0 := { x ∈ R n | h ( x ) ≥ 0 } . Consider the system in R 2 with dynamics ˙ x 1 = 0 , ˙ x 2 = u inside the unit ball, and ˙ x 1 = x 1 (1 -√ x 2 1 + x 2 2 ) / √ x 2 1 + x 2 2 , ˙ x 2 = x 2 (1 -√ x 2 1 + x 2 2 ) / √ x 2 1 + x 2 2 + u outside of it, where the admissible control set is U = {-1 , +1 } . Define the function h : R 2 → R 2 by h ( x 1 , x 2 ) = 1 -x 2 1 -x 2 2 . To see that h is indeed a CBF, observe that max u ∈U ∇ h ( x 1 , x 2 ) · f (( x 1 , x 2 ) , u ) = 2 | x 2 | ≥ -h ( x 1 , x 2 ) inside the unit ball and max u ∈U ∇ h ( x 1 , x 2 ) · f (( x 1 , x 2 ) , u ) = 2 √ x 2 1 + x 2 2 ( √ x 2 1 + x 2 2 -1) + 2 | x 2 | ≥ -h ( x 1 , x 2 ) outside the unit ball.

We will show that the set S ≥ 0 := { ( x 1 , x 2 ) ∈ R 2 | h ( x 1 , x 2 ) ≥ 0 } = { ( x 1 , x 2 ) ∈ R 2 | x 2 1 + x 2 2 ≤ 1 } is not control-invariant. To do so, consider the initial state (¯ x 1 , ¯ x 2 ) := (1 , 0) ∈ S ≥ 0 , and let u ∈ U (i.e. u : R ≥ 0 → U be an arbitrary measurable control signal that takes on only admissible control values). For convenience, let ( x 1 ( · ) , x 2 ( · )) ≡ x u (¯ x 1 , ¯ x 2 ) ( · ) .

It follows that ∫ t 0 u ( τ ) d τ = x 2 ( t ) = 0 for all t ≥ 0 . Thus ∫ b a u ( τ ) d τ = 0 for all a, b &gt; 0 . But the Lebesgue Differentiation Theorem (Theorem 3.21 in [18]), u ( t ) = 0 for a.e. t ≥ 0 , violating the assumption that u ( · ) ∈ {-1 , +1 } .

Suppose that indeed x 1 ( t ) 2 + x 2 ( t ) 2 ≤ 1 for all t ≥ 0 . Then ˙ x 1 ( · ) ≡ 0 so that x 1 ( · ) ≡ 1 and x 2 ( · ) ≡ 0 .

## ACKNOWLEDGMENT

The authors thank Dr. Jorge Cort´ es for useful discussions.

## REFERENCES

- [1] A. D. Ames, X. Xu, J. W. Grizzle, and P. Tabuada, 'Control barrier function based quadratic programs for safety critical systems,' IEEE Trans. Autom. Control , vol. 62, no. 8, p. 3861-3876, 2017.
- [2] A. D. Ames, S. Coogan, M. Egerstedt, G. Notomista, K. Sreenath, and P. Tabuada, 'Control barrier functions: Theory and applications,' in Proceedings of the IEEE 18th European Control Conference (ECC) , p. 3420-3431, 2019.
- [3] I. Mitchell, A. Bayen, and C. Tomlin, 'A time-dependent HamiltonJacobi formulation of reachable sets for continuous dynamic games,' IEEE Trans. Autom. Control , vol. 50, no. 7, pp. 947-957, 2005.
- [4] S. Bansal, M. Chen, S. Herbert, and C. J. Tomlin, 'Hamilton-Jacobi reachability: A brief overview and recent advances,' in Proceedings of the 56th IEEE Annual Conference on Decision and Control (CDC) , pp. 2242-2253, 2017.
- [5] K. Margellos and J. Lygeros, 'Hamilton-Jacobi formulation for reach-avoid differential games,' IEEE Trans. Autom. Control , vol. 56, no. 8, pp. 1849-1861, 2011.
- [6] J. F. Fisac, M. Chen, C. J. Tomlin, and S. S. Sastry, 'Reach-avoid problems with time-varying dynamics, targets and constraints,' in Proceedings of the 18th International Conference on Hybrid Systems: Computation and Control (HSCC) , p. 11-20, 2015.
- [7] A. Altarovici, O. Bokanowski, and H. Zidani, 'A general HamiltonJacobi framework for non-linear state-constrained control problems,' ESAIM: Control, Optimisation and Calculus of Variations , vol. 19, no. 2, p. 337-357, 2012.
- [8] W. Xiao, C. Belta, and C. G. Cassandras, 'Adaptive control barrier functions,' IEEE Trans. Autom. Control , vol. 67, p. 2267-2281, May 2022.
- [9] P. Glotfelter, J. Cortes, and M. Egerstedt, 'Nonsmooth barrier functions with applications to multi-robot systems,' IEEE Control Systems Letters , vol. 1, no. 2, p. 310-315, 2017.
- [10] P. Glotfelter, J. Cortes, and M. Egerstedt, 'A nonsmooth approach to controller synthesis for Boolean specifications,' IEEE Trans. Autom. Control , vol. 66, p. 5160-5174, Nov. 2021.
- [11] J. J. Choi, D. Lee, K. Sreenath, C. J. Tomlin, and S. L. Herbert, 'Robust control barrier-value functions for safety-critical control,' in Proceedings of the 60th IEEE Conference on Decision and Control (CDC) , p. 6814-6821, 2021.
- [12] F. Camilli, L. Gr¨ une, and F. Wirth, 'Control Lyapunov functions and Zubov's method,' SIAM J. Control , vol. 47, p. 301-326, Jan. 2008.
- [13] H. K. Khalil, Nonlinear Systems . Prentice Hall, 3 ed., 2002.
- [14] M. Bardi and I. Capuzzo-Dolcetta, Optimal Control and Viscosity Solutions of Hamilton-Jacobi-Bellman Equations . Birkhauser, 1997.
- [15] L. C. Evans, Partial Differential Equations . American Mathematical Society, 2010.
- [16] W. H. Fleming and H. M. Soner, Controlled Markov Processes and Viscosity Solutions . Springer-Verlag, 1993.
- [17] E. Barron and H. Ishii, 'The Bellman equation for minimizing the maximum cost,' Nonlinear Analysis: Theory, Methods &amp; Applications , vol. 13, no. 9, p. 1067-1090, 1989.
- [18] G. B. Folland, Real Analysis: Modern Techniques and Their Applications . John Wiley &amp; Sons, Inc., 2 ed., 1999.