## Computing Control Lyapunov-Barrier Functions: Softmax Relaxation and Smooth Patching with Formal Guarantees

Jun Liu and Maxwell Fitzsimmons

Abstract -We present a computational framework for synthesizing a single smooth Lyapunov function that certifies both asymptotic stability and safety. We show that the existence of a strictly compatible pair of control barrier and control Lyapunov functions (CBF-CLF) guarantees the existence of such a function on the exact safe set certified by the barrier. To maximize the certifiable safe domain while retaining differentiability, we employ a log-sum-exp (softmax) relaxation of the nonsmooth maximum barrier, together with a counterexampleguided refinement that inserts half-space cuts until a strict barrier condition is verifiable. We then patch the softmax barrier with a CLF via an explicit smooth bump construction, which is always feasible under the strict compatibility condition. All conditions are formally verified using a satisfiability modulo theories (SMT) solver, enabled by a reformulation of Farkas' lemma for encoding strict compatibility. On benchmark systems, including a power converter, we show that the certified safe stabilization regions obtained with the proposed approach are often less conservative than those achieved by state-of-theart sum-of-squares (SOS) compatible CBF-CLF designs.

[2], which can be solved efficiently and deployed online, for instance through model predictive control (MPC) [30]. The main challenge lies in guaranteeing compatibility between the two functions so that the optimization remains feasible. When compatibility is absent, stability is often relaxed and treated as a soft constraint [2], [12], [21]. A further limitation is that such optimization-based formulations may introduce undesired dynamics such as additional equilibrium points [21], and the provable region of attraction, if any, is often considerably smaller than the certified safe region.

Index Terms -Safety; Stability; Formal verification; Control Lyapunov function; Control barrier function; Smooth patching.

## I. INTRODUCTION

In many control applications, stability alone is no longer sufficient; formal safety guarantees are equally necessary. Feedback controllers must not only stabilize the system but also enforce state constraints, a requirement that is especially critical in domains such as autonomous vehicles, industrial processes, and robotics, where safe operation is essential for real-world deployment.

Control Lyapunov functions (CLFs) provide a classical framework for stabilizing nonlinear systems, with necessary and sufficient conditions for their existence established in [3] and later exploited to derive a universal control law for control-affine nonlinear systems [27]. Similarly, control barrier functions (CBFs) [2], [29], [31] enforce safety by constraining the Lie derivative of a barrier function, but they alone do not guarantee stability. This gap has motivated increasing interest in safe stabilization and reach-avoid formulations that combine safety with stability or reachability, as studied in works such as [9], [11], [12], [18], [21]-[25].

A widely used strategy is to couple CBFs and CLFs within an optimization-based framework. For control-affine systems, this is typically formulated as a quadratic program (QP) [1],

This research was supported in part by the Natural Sciences and Engineering Research Council of Canada and the Canada Research Chairs program.

Jun Liu and Maxwell Fitzsimmons are with the Department of Applied Mathematics, University of Waterloo, Waterloo, Ontario N2L 3G1, Canada. Email: j.liu@uwaterloo.ca (Jun Liu)

An alternative approach is to merge a CLF and a CBF into a single control Lyapunov-barrier function (CLBF) [25]. Once such a function is available, Sontag's universal formula [27] (or QP with guaranteed feasibility) can be applied to construct a safe stabilizing controller. While conceptually appealing, the drawback-as highlighted in [5], [6] and further discussed in [18], [22]-is that the CLBF conditions of [25] generally fail to hold unless stringent assumptions on the safe set are satisfied. The difficulty stems from topological obstructions: a system with state constraints, whether imposed explicitly by safety requirements or implicitly by limited controllability, may not admit a continuous stabilizing feedback. We refer the reader to the expository work [28] for a discussion on the necessity of discontinuous feedback in nonlinear stabilization.

Converse Lyapunov theorems for safety [13] and for stability under safety constraints [18] are useful for theoretically understanding when a single Lyapunov function can certify both stability and safety. The work in [13] provided a characterization of robust safety using Lyapunov functions. In [18], a general theoretical framework was established that connects Lyapunov and barrier functions through converse results, ensuring stability together with safety and accommodating reach-avoid-stay specifications. This framework has also been extended to cover hybrid systems [19] and stochastic systems [20]. Building on [18], the recent work [22] broadened the scope by deriving necessary conditions for the existence of CLBFs and for the compatibility of CBFCLF pairs. Complementary to these results, the converse Lyapunov theorem developed in [24] shows that a strictly compatible pair of control Lyapunov and control barrier functions exists if and only if there is a single smooth Lyapunov function that simultaneously certifies asymptotic stability and safety.

Inspired by the work above, and in particular [24], the present paper develops a computational framework to unify strictly compatible CBFs and CLFs into a single CLBF for safe stabilization. Our first motivation is to enlarge the safe stabilization region compared with current approaches based on compatible CBF-CLF pairs [7], [12]. To this end, we propose a natural log-sum-exp (softmax) relaxation of a maximum barrier function, obtained from sublevel safety constraints, as a candidate CBF. Surprisingly, this simple choice often yields barrier functions that are formally verifiable. When verification fails, we introduce a counterexampleguided synthesis procedure that iteratively inserts half-space cuts until a verifiable barrier is obtained. We find that this significantly extends the safe stabilization region achieved by existing CBF-CLF synthesis methods [7], [12], as it does not restrict barrier functions to a fixed template and instead allows them to adapt to the geometry of the safe set. We then search for a compatible CLF and prove theoretically that, under a strict compatibility condition, it is always possible to patch the compatible CBF-CLF pair into a single smooth CLBF. In contrast to methods that require compatibility over larger domains, our approach only imposes strict compatibility on the boundary of the safe set, making the search for compatible CLFs more tractable. Through a series of benchmark examples, we demonstrate that the proposed method outperforms alternative approaches, including sumof-squares (SOS) synthesis of compatible CBF-CLF pairs.

## II. PRELIMINARIES AND PROBLEM FORMULATION

## A. System description

Consider a nonlinear system in control-affine form

<!-- formula-not-decoded -->

where f : R n → R n and g : R n → R n × m with f (0) = 0 . We aim to design a state-feedback controller u = κ ( x ) , where κ : R n → R m and κ (0) = 0 , such that the origin remains an equilibrium point of the closed-loop system

<!-- formula-not-decoded -->

and solutions of (2) satisfy additional properties. In this paper, we focus on asymptotic stabilization under state constraints.

Given a control input u : [0 , ∞ ) → R m and functions f and g satisfying mild conditions, for example u is locally essentially bounded and f , g are locally Lipschitz, system (1) admits a unique solution ϕ ( t ; x, u ) on its maximal interval of existence. Here, ϕ ( t ; x, u ) denotes the unique trajectory of (2) starting from x (0) = x under the control input u . We call an input signal admissible if a solution exists for it.

## B. Safety constraints

Consider multiple state constraints of the form

<!-- formula-not-decoded -->

where each h i : , R n → R is continuously differentiable. We assume that the safe set is defined as the intersection of the sets above:

<!-- formula-not-decoded -->

Equivalently, the safe set can be written as

<!-- formula-not-decoded -->

where h max ( x ) := max 1 ≤ i ≤ N h i ( x ) . Note that h max is generally not continuously differentiable.

Safety is enforced by requiring that solutions of the closedloop system (2) remain in the set C safe whenever they start in C safe. Additionally, we impose asymptotic stability. Assuming that the origin lies in the interior of C safe, we seek a feedback controller u = κ ( x ) such that the origin is asymptotically stable for the closed-loop system (2), and solutions starting in C safe remain in C safe and converge to the origin as t →∞ .

This is not always possible unless the set C safe is a controlled forward invariant set for (1) and is contained within the domain of null controllability of (1).

Definition 1: A set C ⊆ R n is called controlled forward invariant for system (1) if for every x ∈ C there exists an admissible control input u such that ϕ ( t ; x, u ) is defined for all t ≥ 0 and satisfies ϕ ( t ; x, u ) ∈ C for all t ≥ 0 .

Definition 2: The domain of null controllability for (1) is defined as

<!-- formula-not-decoded -->

## C. Problem formulation

We seek to find a tight under-approximation of C safe , denoted by C , that is represented as the 1-sublevel set of a continuously differentiable function W : R n → R , i.e.,

<!-- formula-not-decoded -->

Furthermore, we require that W serves as a control Lyapunov function for (1) on C ; that is, W is positive definite and

<!-- formula-not-decoded -->

where L f W = ∇ W ⊤ f and L g W = ∇ W ⊤ g . As a result, standard results from nonlinear control (e.g., Sontag's universal formula [27]) apply directly to W to obtain a safe, stabilizing controller-one of the main benefits of having a single smooth Lyapunov function. These results ensure we can construct a feedback controller that is continuous everywhere except possibly at the origin.

Remark 1: We take a unifying approach that employs a single Lyapunov function to certify both safety and stability, in contrast to the common approach of using a separate barrier function and a Lyapunov function [2]. It has been shown in the literature that, under mild assumptions, this can be done without loss of generality; see, for example, [13], [18], [22], [24] for characterizations of safety and stability using converse Lyapunov functions. In this work, we focus on demonstrating the computational feasibility and benefits of unifying barrier and Lyapunov functions. Despite being merely a control Lyapunov function, W is also referred to as a control Lyapunov-barrier function (CLBF) to emphasize its dual role in simultaneously certifying stability and safety, in line with recent work on unified Lyapunov-barrier certificates [18], [22], [24], [25].

## III. SOFTMAX RELAXATION OF THE SAFE SET

Often, one of the objectives of a safe stabilizing controller is to maximize the safe domain of attraction, namely the set of initial conditions that converge to the origin while remaining in the safe set C safe. A natural choice is to design a barrier function whose 1 -sublevel set coincides with C safe . Indeed, h max in (5) provides an exact characterization of C safe via its 1 -sublevel set. A potential drawback of using h max directly, however, is that it is generally not differentiable.

## A. Softmax relaxation of the safe set

We approximate h max by the smooth log-sum-exp with temperature τ &gt; 0 :

<!-- formula-not-decoded -->

We have the following well-known property of h sm . The proof is elementary, but we include it for completeness.

Proposition 1: x ∈ R

For all n ,

<!-- formula-not-decoded -->

.

Proof: Fix x ∈ R n . Let a i := h i ( x ) for i = 1 , . . . , N and a max := max i a i . Then

<!-- formula-not-decoded -->

since e τa i ≤ e τa max for all i . Taking logarithms and dividing by τ &gt; 0 gives

<!-- formula-not-decoded -->

which is precisely the desired inequality.

An immediate consequence of Proposition 1 is that

<!-- formula-not-decoded -->

In other words, the 1-sublevel set of h sm gives a guaranteed under-approximation of the safe set, and, as τ →∞ , h sm → h max uniformly on compact sets.

## B. Control barrier condition

Consider a continuously differentiable function h : R n → R . Denote

<!-- formula-not-decoded -->

<!-- formula-not-decoded -->

We rely on the following strict barrier condition on h to ensure controlled invariance of the set C .

Definition 3: We say that h is a strict control barrier function on C if, for every x ∈ ∂ C , there exists u ∈ R m such that

<!-- formula-not-decoded -->

Example 3.1: We consider the following toy example taken from [7] to illustrate the construction of a nearmaximal smooth barrier function and its verification.

a) System dynamics: Let x = ( x 1 , x 2 ) ⊤ and consider the control-affine system (1) with

<!-- formula-not-decoded -->

and domain [ -π, π ] × [ -3 , 4] .

b) Hard constraints: The safe set is defined by

<!-- formula-not-decoded -->

together with box constraints encoding the domain:

<!-- formula-not-decoded -->

for j = 1 , 2 , where x j and ¯ x j denote the lower and upper bounds of the j th coordinate.

c) Verified smooth barrier: Let h 1 , . . . , h N ( N = 5 ) be all constraints above. We construct a smooth log-sumexp approximation h sm ( x ; τ ) as defined in ( 8). For a wide range of τ values, we can formally verify (details to provide in Section V) the strict barrier condition (12). Fig. 1 depicts formally verified h sm ( x ; τ ) for τ = 1 . 5 and τ = 4 . 5 . It clearly shows that increasing τ leads to a closer approximation of the exact safe set boundary. As a comparison, we also depict a state-of-the-art approach that synthesizes compatible Lyapunov and barrier functions using sum-of-squares (SOS) as a comparison. Of course, at the moment, we have only discussed the barrier condition. With the results to be presented in Section IV, we will be able to produce a formally verified single smooth Lyapunov-barrier function that achieves the exact same safe stabilization region enclosed by the softmax barrier.

Fig. 1: Smooth barrier function h sm ( x ) (left) and its 1 -level set (right). As a comparison, the best verified safe controllable region obtained using SOS CBF-CLF is shown in dotted red. It can be seen that the softmax relaxation barrier outperforms the SOS approach [7]. Data for comparisons in this and subsequent examples were extracted from published figures using the WebPlotDigitizer tool [16].

<!-- image -->

## C. Counterexample-guided refinement

While in many cases, as we shall see in Section VI, the softmax relaxation barriers readily satisfy the strict barrier condition, there are scenarios in which this is not the case. We present a counterexample-guided refinement procedure that iteratively adds new half-space constraints to the softmax approximation until the barrier condition becomes verifiable.

a) Construction of half-space cuts: Suppose that h sm ( x ; τ ) fails the barrier condition at some counterexample x ∗ ∈ ∂ C provided by the verifier. Let

<!-- formula-not-decoded -->

denote the outward unit normal of the current softmax level set at x ∗ . To exclude this point, we generate a new half-space

<!-- formula-not-decoded -->

where n new is a slight rotation of n :

<!-- formula-not-decoded -->

with a small angle θ &gt; 0 . The plane is shifted inward by a small margin ε &gt; 0 , b new := n ⊤ new x ∗ -ε, so that x ∗ lies strictly outside the updated safe set. The refined constraint set is then

<!-- formula-not-decoded -->

and a new softmax h sm ( x ; τ ) is built from this set.

b) Algorithm: The procedure repeats this step until either the barrier condition is verified or a maximum number of cuts is reached. This is summarized in Algorithm 1.

## Algorithm 1: Counterexample-Guided Softmax Barrier Refinement

Input: Initial constraints { h i ( x ) ≤ 1 } N i =1 , temperature τ &gt; 0

- 1 Build h sm ( x ; τ ) via (8);
- 2 while Verifier finds counterexample x ∗ and iteration count &lt; k max do
- 3 Compute normal n ←∇ h sm ( x ∗ ; τ ) / ∥∇ h sm ( x ∗ ; τ ) ∥ ;
- 4 Choose small angle θ &gt; 0 and orthogonal direction r ⊥ n ;
- 5 Set n new ← n cos θ + r sin θ ;
- 6 Set b new ← n ⊤ new x ∗ -ε ;
- 7 Add new half-space constraint

h

new

(

x

) :=

n

⊤

new

x

-

b

new

+1

;

- 8 Rebuild h sm ( x ; τ ) with augmented constraint set;

Refined h ( x ; τ ) satisfying barrier

Output: sm condition

Example 3.2: We consider the nonlinear control-affine system (1), taken from [8], with

<!-- formula-not-decoded -->

and domain [ -4 . 5 , 4 . 5] 2 . The unsafe set is given by the single half-space h 1 ( x ) := -2 -x 1 -x 2 ≤ 1 , together with the box constraints defining the domain. We construct a softmax relaxation h sm ( x ; τ ) with τ = 3 . 0 . Direct verification of the control barrier condition on h sm = 1 fails, but applying the counterexample-guided refinement procedure from Algorithm 1 adds a sequence of half-space cuts. Upon termination, the refined softmax barrier is formally verified, and its 1 -sublevel set provides a guaranteed controlled invariant subset of the original safe set. Fig. 2 depicts the verified refined softmax barrier for this example.

<!-- image -->

1

Fig. 2: Smooth barrier function h sm ( x ) (left) and its 1 -level set (right) obtained by softmax relaxation and counterexample-guided refinement (Algorithm 1. As a comparison, the best verified safe controllable region obtained using SOS CBF-CLF is shown in dotted red. The softmax relaxation barrier outperforms the SOS approach [8].

## IV. STRICT COMPATIBILITY IMPLIES SMOOTH PATCHING

In the previous section, we demonstrated that the softmax relaxation can yield a significantly less conservative barrier for safety. To ensure safe stabilization, however, we must combine it with a Lyapunov function for stabilization, posed as the main problem in Section II-C. We address this issue in the present section. The theoretical foundation is a converse Lyapunov theorem for joint safety and stability recently proved in [24]. Our focus here is on efficient and verifiable computation. The proposed approach uses smooth patching with formal guarantees and relies on satisfiability modulo theories (SMT) verification and an analytical formula to patch strictly compatible control barrier and Lyapunov functions. We present this as the main result of the paper.

## A. Strictly compatible CBF and CLF

Consider a candidate CBF h : R n → R and a candidate CLF V : R n → R . We assume that both h and V are continuously differentiable, V is positive definite, and the set C defined by (10) contains the origin in its interior.

Definition 4: We say that h and V are strictly compatible if the following conditions hold:

- 1) For every x ∈ C \ { 0 } , there exists u ∈ R m such that

<!-- formula-not-decoded -->

- 2) For every x ∈ ∂ C , there exists u ∈ R m such that

<!-- formula-not-decoded -->

and

<!-- formula-not-decoded -->

Remark 2: We impose the strict form of inequality (16) to ensure robust invariance of ∂ C . This is essential for it to be verifiable by δ -complete SMT solvers such as dReal

[10]. We also relax the compatibility conditions, see, e.g., [7], [21], [23], to hold only on the boundary of the set C .

## B. Smooth patching with guarantees

We establish the following result on patching a strictly compatible CBF and CLF pair to form a single smooth Lyapunov-barrier function (CLBF).

Theorem 1: Let h and V be strictly compatible as defined in Definition 4. Suppose that the set C is compact. Then there exists a continuously differentiable function W : R n → R with the following properties:

- 1) C = { x ∈ R n | W ( x ) ≤ 1 } .
- 2) For every x ∈ C \ { 0 } , there exists u ∈ R m such that

<!-- formula-not-decoded -->

Proof: Fix ε ∈ (0 , 1) and define the inner boundary band

<!-- formula-not-decoded -->

By strict compatibility and compactness of C , we can choose ε &gt; 0 such that, for every x ∈ ∂ C -ε , there exists u such that both L f V ( x ) + L g V ( x ) u &lt; 0 and L f h ( x ) + L g h ( x ) u &lt; 0 . We also assume that ε &gt; 0 is sufficiently small such that 0 ̸∈ ∂ C -ε .

Since C is compact, we can choose α &gt; 0 such that V 2 := αV satisfies

<!-- formula-not-decoded -->

Indeed, we can simply choose

<!-- formula-not-decoded -->

Define a C 1 bump function supported on the band:

<!-- formula-not-decoded -->

Now define the patched function

<!-- formula-not-decoded -->

which is C 1 by construction, with gradient

<!-- formula-not-decoded -->

We verify the following properties of W .

Property (1): Exact safe set. If h &gt; 1 , then b = 1 and W = h &gt; 1 . This implies { W ≤ 1 } ⊆ { h ≤ 1 } .

If h ≤ 1 -ε , then b = 0 and W = V 2 ≤ 1 . If 1 -ε &lt; h &lt; 1 , then 0 &lt; b &lt; 1 and W = (1 -b ) V 2 + bh ≤ 1 since V 2 ≤ 1 on C and h ≤ 1 in the band. These together imply { h ≤ 1 } ⊆ { W ≤ 1 } .

Thus { W ≤ 1 } = { h ≤ 1 } = C .

Property (2): Strict CLF condition. Following (19), we further compute

<!-- formula-not-decoded -->

,

where

<!-- formula-not-decoded -->

Take x ∈ C \ { 0 } .

- If h ( x ) ≤ 1 -ε , then b = 0 , ∇ b = 0 , and ∇ W = ∇ V 2 = α ∇ V . The CLF condition (17) holds for W because V satisfies the CLF condition (14).
- If 1 -ε &lt; h ( x ) ≤ 1 , then

<!-- formula-not-decoded -->

where p ≥ 0 and h -V 2 ≥ 0 . By strict compatibility of h and V , for each x , there exists u such that ∇ h ⊤ ( f + gu ) &lt; 0 and ∇ V ⊤ 2 ( f + gu ) &lt; 0 simultaneously. This implies ∇ W ⊤ ( f + gu ) &lt; 0 .

Therefore, for every x ∈ C \ { 0 } , there exists u such that L f W ( x ) + L g W ( x ) u &lt; 0 .

The following corollary is a direct application of Theorem 1 and is a well-established result in nonlinear control.

Corollary 1: Under the assumptions of Theorem 1, there exists a feedback controller κ : R n → R such that the origin is asymptotically stable for the closed-loop system (2), and solutions starting in C remain in C and converge to the origin as t → ∞ . Furthermore, κ can be chosen to be smooth on R n \ { 0 } .

Remark 3: If V satisfies the small control property [27], then so does W constructed in (18). Consequently, the feedback law κ in the corollary is continuous at the origin. Moreover, κ can be explicitly constructed using Sontag's universal stabilization formula [27].

## V. SMT VERIFICATION

In this section, we discuss formal verification of the strict barrier condition (12) introduced in Section III and the strict compatibility between control barrier and Lyapunov conditions defined in Section IV. Once these conditions are verified, the function W constructed in Theorem 1 is a continuously differentiable CLBF that can be used for safe stabilization.

## A. Verification of strict CBF

The strict CBF condition (12) is equivalent to

<!-- formula-not-decoded -->

The barrier function h constructed using the softmax relaxation (8) involves transcendental functions log and exp . Over a compact domain, condition (20) can be readily verified by a δ -complete SMT solver such as dReal [10].

## B. Verification of CBF-CLF compatibility

The strict compatibility conditions proposed in Definition 4 include a CLF condition for V on C , which is equivalent to

<!-- formula-not-decoded -->

Similar to (20), this can be readily verified using an SMT solver such as dReal [10]. The synthesis of CLFs using SMT

solvers and neural networks has been discussed in detail in [14]. We refer the reader to [14] for a detailed discussion of the formal verification of the CLF condition (21), in particular the treatment of difficulties near the origin when using dReal, which is only δ -complete and may return spurious counterexamples in a neighborhood of the origin.

Furthermore, Definition 4 includes a strict compatibility condition (15)-(16) between V and h on the boundary of C . Because this condition has the quantifier structure ∀ x ∃ u , it cannot be readily handled by dReal, which supports only quantifier-free or purely universal formulas. We use the following variant of Farkas' lemma [17, Proposition 6.4.3, p. 90] to addresses this issue.

Lemma 1 (Farkas' Lemma): Let A ∈ R n × m and b ∈ R n . The system Au ≤ b , u ∈ R m , has a solution if and only if every nonnegative y ∈ R n with y ⊤ A = 0 ⊤ ∈ R 1 × m also satisfies y ⊤ b ≥ 0 .

We reformulate Farkas' Lemma in a strict inequality form and add a normalization to the vector y .

## Lemma 2 (Farkas' Lemma Reformulation): Let

A ∈ R n × m and b ∈ R n . The system Au &lt; b , u ∈ R m , has a solution if and only if every nonnegative λ ∈ R n with λ ⊤ A = 0 ⊤ ∈ R 1 × m and ∑ n i =1 λ i = 1 also satisfies λ ⊤ b &gt; 0 .

Proof: ( ⇒ ) We have

<!-- formula-not-decoded -->

because each b i -a ⊤ i u &gt; 0 and λ i ≥ 0 with ∑ n i =1 λ i = 1 . ( ⇐ ) Suppose no u satisfies Au &lt; b . Then for every u there exists an index i such that a ⊤ i u ≥ b i . Equivalently, the convex sets

<!-- formula-not-decoded -->

are disjoint. By the separating hyperplane theorem [4, Section 2.5.1], there exists a nonzero vector ˜ λ ∈ R n such that

<!-- formula-not-decoded -->

The second condition implies ˜ λ ≥ 0 . The first condition implies ˜ λ ⊤ A = 0 (otherwise one can choose u in the direction of -( ˜ λ ⊤ A ) to violate the inequality), and then ˜ λ ⊤ b ≤ 0 . Set

<!-- formula-not-decoded -->

so that λ ≥ 0 , ∑ i λ i = 1 , λ ⊤ A = 0 , and λ ⊤ b ≤ 0 . This contradicts the assumption that all such λ satisfy λ ⊤ b &gt; 0 . Therefore, ∃ u with Au &lt; b .

We now state the conditions that we can verify for strict compatibility.

Lemma 3: The strict compatibility condition (15)-(16) is equivalent to

<!-- formula-not-decoded -->

Proof: Write

<!-- formula-not-decoded -->

Fix any x ∈ ∂ C and write λ = ( λ 1 , λ 2 ) ⊤ . Then the strict compatibility is ∃ u : A ( x ) u &lt; b ( x ) componentwise, and (22) is

<!-- formula-not-decoded -->

Their equivalence is precisely Lemma 2.

Remark 4: We consider a strict inequality formulation and add a simplex normalization to λ so that (22) can be handled by δ -complete SMT solvers such as dReal [10], which are effective essentially only for strict inequalities over compact domains.

Remark 5: We verify (20), (21), and (22) sequentially. To enable guaranteed patching of CBF and CLF by Theorem 1 using the explicit formula (18), we also do a bisection search to compute ε ∈ (0 , 1) such that

<!-- formula-not-decoded -->

is verified. This implies strict compatibility of h and V on the band

<!-- formula-not-decoded -->

defined in the proof of Theorem 1. Upon successful verification of these inequalities, the single Lyapunov function W defined by (18) provides both a certificate and a means for computing provably safe, stabilizing controllers. In the next section, we demonstrate that this approach is effective and can provide less conservative safe stabilization regions, compared to alternative approaches.

## VI. NUMERICAL EXAMPLES

We illustrate the effectiveness of the proposed approach with several nonlinear control examples. All computations were performed on a 2020 MacBook Pro with a 2 GHz quadcore Intel Core i5 processor and solved within the toolbox LyZNet [15], supported by dReal [10] as the verification engine. The code for all examples presented here, as well as additional examples, is available at https://git. uwaterloo.ca/hybrid-systems-lab/lyznet under examples/patch-clbf .

Example 6.1: We first revisit Example 3.1. Upon formally verifying the softmax barrier h = h sm , defined in (8) with τ = 4 . 5 , as a strict barrier function using (20), we also formally verify its strict compatibility with a quadratic CLF. The strict barrier condition was certified in less than 0 . 01 s, and strict compatibility in 0 . 42 s. The latter involved a bisection procedure to determine the largest ε such that strict compatibility (23) holds on the band { x : 1 -ε ≤ h ( x ) ≤ 1 } (capped at ε = 0 . 5 ). The CLF we verify is the quadratic function V ( x ) = x 2 1 + 2 x 2 2 . Figure 3 depicts the patched

CLBF and the phase portrait of the closed-loop system under Sontag's controller [27]. Figure 4 shows 50 simulated trajectories from the set C = { h ≤ 1 } , along with the evaluation of h to demonstrate safety. The barrier function h itself cannot serve as a Lyapunov function on C , not only because it takes negative values, but also because it has a stationary point at x = (0 . 1294085 , 0 . 94176161) ⊤ (numerically confirmed via gradient descent). Patching it with a quadratic CLF yields a provable CLBF, as demonstrated here.

Fig. 3: A smooth Lyapunov-barrier function patched from a strictly compatible CBF-CLF pair for Example 6.1. The green dash-dotted line represents the formally verified safe stabilization region, relative to the unsafe region (shaded in light red). For comparison, the best verified safe controllable region obtained using compatible SOS CBF-CLF [7] is shown in dotted red, while the dashed red curve depicts the largest safe stabilization region certified by a quadratic CLF.

<!-- image -->

Fig. 4: Simulated trajectories and corresponding barrier function values for Example 6.1. All trajectories converge, and the barrier function values remain below the safe threshold of 1.

<!-- image -->

Example 6.2: Revisit Example 3.2. We are able to formally verify strict compatibility of the CBF h depicted in Fig. 2 with the simple CLF V ( x ) = x 2 1 + x 2 2 . The patched CLBF using (18) and Theorem 1 is shown in Fig. 5, along with the phase portrait of the closed-loop system.

Example 6.3: We consider the nonlinear control-affine system (1), taken from [8], with

<!-- formula-not-decoded -->

and domain [ -10 , 10] 2 . The unsafe set is given by the single half-space h 1 ( x ) := -2 -x 1 -x 2 ≤ 1 , together with the box constraints defining the domain. We can verify strict compatibility of the softmax barrier function h = h sm ( τ =

Fig. 5: A smooth control Lyapunov-barrier function patched from a strictly compatible CBF-CLF pair for Example 6.2. The green dash-dotted line represents the formally verified safe stabilization region, relative to the unsafe region (shaded in light red). For comparison, the best verified safe controllable region obtained using compatible SOS CBF-CLF [8] is shown in dotted red, while the dashed red curve depicts the largest safe stabilization region certified by a quadratic CLF.

<!-- image -->

10 . 0 ) with a quadratic CLF V . The resulting patched CLBF using (18) and Theorem 1 is depicted in Fig. 6.

Fig. 6: A smooth control Lyapunov-barrier function patched from a strictly compatible CBF-CLF pair for Example 6.3. The green dash-dotted line represents the formally verified safe stabilization region, relative to the unsafe region (shaded in light red). For comparison, the best verified safe controllable region obtained using compatible SOS CBF-CLF [8] is shown in dotted red.

<!-- image -->

Example 6.4: We consider the case study of a power converter, taken from [26] and also used in [8], which is a nonlinear control-affine system (1) with

<!-- formula-not-decoded -->

on the domain [ -2 , 2] 3 . The unsafe set is specified by

<!-- formula-not-decoded -->

together with the box constraints defining the domain. Here, the state vector x = ( x 1 , x 2 , x 3 ) ⊤ corresponds to the measured quantities ( v dc , i d , i q ) ⊤ , where v dc is the DC-link voltage and i d , i q are the direct- and quadrature-axis currents in the synchronous dq -frame [26]. We construct a softmax barrier function h = h sm with τ = 3 . 1 and verify strict compatibility with a quadratic CLF V on the boundary band. The strict barrier condition was certified in less than 0 . 01 s, and strict compatibility in 0 . 59 s. The patched CLBF obtained from (18) using Theorem 1 is depicted in Fig. 7.

Fig. 7: A patched control Lyapunov-barrier function for Example 6.4. The green dash-dot curve represents the formally verified safe stabilization region, relative to the unsafe region (shaded in light red). For comparison, the best reported SOS CBF-CLF result [8] is shown in dotted red.

<!-- image -->

## VII. CONCLUSIONS

We developed a computational framework for constructing a single smooth Lyapunov function that certifies both stability and safety, enabled by softmax barrier relaxations, strict compatibility verification of CBF-CLF pairs, and explicitly defined smooth patching. Formal guarantees were established using δ -complete SMT solvers, and the method was demonstrated on benchmark systems and compared with an alternative sum-of-squares approach. Future work will focus on incorporating input constraints and extending the approach with compositional verification techniques to scale to high-dimensional systems.

## REFERENCES

- [1] Aaron D Ames, Samuel Coogan, Magnus Egerstedt, Gennaro Notomista, Koushil Sreenath, and Paulo Tabuada. Control barrier functions: Theory and applications. In Proc. of ECC , 2019.
- [2] Aaron D Ames, Xiangru Xu, Jessy W Grizzle, and Paulo Tabuada. Control barrier function based quadratic programs for safety critical systems. IEEE Transactions on Automatic Control , 62(8):3861-3876, 2017.
- [3] Zvi Artstein. Stabilization with relaxed controls. Nonlinear Analysis: Theory, Methods &amp; Applications , 7(11):1163-1173, 1983.
- [4] Stephen P Boyd and Lieven Vandenberghe. Convex Optimization . Cambridge University Press, 2004.
- [5] Philipp Braun and Christopher M Kellett. On (the existence of) control Lyapunov barrier functions. 2017.
- [6] Philipp Braun and Christopher M Kellett. Comment on 'Stabilization with guaranteed safety using control Lyapunov-barrier function'. Automatica , 122:109225, 2020.
- [7] Hongkai Dai, Chuanrui Jiang, Hongchao Zhang, and Andrew Clark. Verification and synthesis of compatible control Lyapunov and control barrier functions. In 2024 IEEE 63rd Conference on Decision and Control (CDC) , pages 8178-8185. IEEE, 2024.
- [8] Hongkai Dai, Chuanrui Jiang, Hongchao Zhang, and Andrew Clark. Verification and synthesis of compatible control Lyapunov and control barrier functions. arXiv preprint arXiv:2406.18914v1 , 2024.
- [9] Charles Dawson, Zengyi Qin, Sicun Gao, and Chuchu Fan. Safe nonlinear control using robust neural Lyapunov-barrier functions. In Conference on Robot Learning , pages 1724-1735. PMLR, 2022.
- [10] Sicun Gao, Soonho Kong, and Edmund M Clarke. dReal: an SMT solver for nonlinear theories over the reals. In Proc. of CADE , pages 208-214, 2013.
- [11] Haoqi Li, Jiangping Hu, Xiaoming Hu, and Bijoy K Ghosh. Stabilization of nonlinear safety-critical systems by relaxed converse Lyapunov-barrier approach and its applications in robotic systems. Autonomous Intelligent Systems , 4(1):1-8, 2024.
- [12] Ming Li and Zhiyong Sun. A graphical interpretation and universal formula for safe stabilization. In 2023 American Control Conference (ACC) , pages 3012-3017. IEEE, 2023.
- [13] Jun Liu. Converse barrier functions via Lyapunov functions. IEEE Transactions on Automatic Control , 67(1):497-503, 2021.
- [14] Jun Liu, Maxwell Fitzsimmons, Ruikun Zhou, and Yiming Meng. Formally verified physics-informed neural control Lyapunov functions. In 2025 American Control Conference (ACC) , pages 1347-1354. IEEE, 2025.
- [15] Jun Liu, Yiming Meng, Maxwell Fitzsimmons, and Ruikun Zhou. LyZNet: A lightweight python tool for learning and verifying neural Lyapunov functions and regions of attraction. In Proceedings of the 27th ACM International Conference on Hybrid Systems: Computation and Control , pages 1-8, 2024.
- [16] F Marin, A Rohatgi, and S Charlot. WebPlotDigitizer, a polyvalent and free software to extract spectra from old astronomical publications: application to ultraviolet spectropolarimetry. In Proc. of SF2A , pages 113-117, 2017.
- [17] Jiˇ r´ ı Matouˇ sek and Bernd G¨ artner. Understanding and Using Linear Programming , volume 1. Springer, 2007.
- [18] Yiming Meng, Yinan Li, Maxwell Fitzsimmons, and Jun Liu. Smooth converse Lyapunov-barrier theorems for asymptotic stability with safety constraints and reach-avoid-stay specifications. Automatica , 144:110478, 2022.
- [19] Yiming Meng and Jun Liu. Lyapunov-barrier characterization of robust reach-avoid-stay specifications for hybrid systems. Nonlinear Analysis: Hybrid Systems , 49:101340, 2023.
- [20] Yiming Meng and Jun Liu. Stochastic Lyapunov-barrier functions for robust probabilistic reach-avoid-stay specifications. IEEE Transactions on Automatic Control , 69(8):5470-5477, 2024.
- [21] Pol Mestres and Jorge Cort´ es. Optimization-based safe stabilizing feedback with guaranteed region of attraction. IEEE Control Systems Letters , 7:367-372, 2022.
- [22] Pol Mestres and Jorge Cort´ es. Converse theorems for certificates of safety and stability, 2025.
- [23] Pio Ong and Jorge Cort´ es. Universal formula for smooth safe stabilization. In 2019 IEEE 58th conference on decision and control (CDC) , pages 2373-2378. IEEE, 2019.
- [24] Thanin Quartz, Maxwell Fitzsimmons, and Jun Liu. A converse control Lyapunov theorem for joint safety and stability. arXiv preprint arXiv:2509.12182 , 2025.
- [25] Muhammad Zakiyullah Romdlony and Bayu Jayawardhana. Stabilization with guaranteed safety using control Lyapunov-barrier function. Automatica , 66:39-47, 2016.
- [26] Michael Schneeberger, Silvia Mastellone, and Florian D¨ orfler. Advanced safety filter based on SOS control barrier and Lyapunov functions. arXiv preprint arXiv:2401.06901 , 2024.
- [27] Eduardo D Sontag. A 'universal' construction of Artstein's theorem on nonlinear stabilization. Systems &amp; Control Letters , 13(2):117-123, 1989.
- [28] Eduardo D Sontag. Stability and stabilization: discontinuities and the effect of disturbances. In Nonlinear analysis, differential equations and control , pages 551-598. Springer, 1999.
- [29] Peter Wieland and Frank Allg¨ ower. Constructive safety using control barrier functions. IFAC Proceedings Volumes , 40(12):462-467, 2007.
- [30] Zhe Wu, Fahad Albalawi, Zhihao Zhang, Junfeng Zhang, Helen Durand, and Panagiotis D Christofides. Control Lyapunov-barrier function-based model predictive control of nonlinear systems. Automatica , 109:108508, 2019.
- [31] Xiangru Xu, Paulo Tabuada, Jessy W Grizzle, and Aaron D Ames. Robustness of control barrier functions for safety critical control. IFAC-PapersOnLine , 48(27):54-61, 2015.