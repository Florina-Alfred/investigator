**Title & Citation**  
*Designing Control Barrier Functions Using a Dynamic Backup Policy* – Victor Freire ∗ and Marco M. Nicotra ∗, Department of Electrical, Computer & Energy Engineering, University of Colorado, Boulder, 2025.  
Available on arXiv (see https://arxiv.org/abs/2404.01445) and a GitHub validation repository `https://github.com/ROCC-Lab-CU-Boulder/traj-DSM-CBF`.  

---

## Abstract  
The paper proposes a systematic, mathematically‑rigorous method to synthesize *control barrier functions* (CBFs) for general control‑affine systems subject to arbitrary state and input constraints.  The key idea is to exploit *dynamic safety margins* (DSMs) that quantify in future time the risk of constraint violation under a **prestabilizing** reference‑dependent policy.  By lifting the problem to the augmented state‑reference space \( (x,v)\in \mathbb R^{n}\times \mathbb R^{l}\), the authors derive a *trajectory‑based DSM* that is shown to be a CBF. Sensitivity analysis of the prestabilised dynamics yields Jacobians that make the DSM’s Lie derivatives tractable, even though the resulting function may be non‑smooth.  A *Clarke generalized Jacobian* formulation ensures that the safety filter remains feasible for any feasible state‑reference pair.  The method is applied to an inverted pendulum on a cart with nonlinear dynamics, multiple constraints and input saturation; simulation demonstrates that the proposed *Traj‑DSM‑CBF* yields the fastest, highest‑performance safe controller among several baselines (nominal, Lyapunov‑based DSM‑CBF, ERG, backup‑CBF).  The authors conclude by noting that the approach is computationally efficient, provably safe, and opens several future research avenues (alternative prediction schemes, disturbance robustness).

---

## Introduction & Motivation  
*Control barrier functions* raise the “control‑affine safety filter” framework of Ames et al. (2017) to active safety enforcement.  While CBFs have been little explored beyond Lyapunov or SOS‐based constructions, practitioners often hand‑pick candidate barrier functions and rely on slack variables, which forfeits the guarantees Krause (2017).  Freire & Nicotra (2025) previously established that *dynamic safety margins* (DSMs) are vector‑valued CBFs in the augmented state‑reference space.  The present work extends those ideas in four definitive ways:  

| Key difference | Description |
|---|---|
| (a) | *Parametrization* of the backup policy by the *equilibrium manifold* \( \bar x(v)\) |
| (b) | The backup policy itself is *dynamic* – the reference \(v\) evolves over time |
| (c) | Under mild assumptions the *sensitivity matrices* of the trajectory prediction are asymptotically stable (Proposition 1) |
| (d) | Nonsmoothness is rigorously addressed via *Clarke generalized Jacobians* (Proposition 3) |

These advances enable a tractable, provably safe CBF synthesis applicable to any locally stabilizable system.

---

## Methods / Approach  

### 1. System Model and Assumptions  
- **Control affine dynamics**  
  \[
  \dot x = f(x)+g(x)u,\;x\in X,\;u\in U
  \]  
  with \( f:\mathbb R^{n}\!\to\!\mathbb R^{n},\,g:\mathbb R^{n}\!\to\!\mathbb R^{n\times m}\) continuously differentiable; \(X,U\) closed (Assumption 2).  
- **Equilibrium manifold**  
  There exist continuous maps  
  \(\bar x:\mathbb R^{l}\!\to\!\mathbb R^{n}\), \(\bar u:\mathbb R^{l}\!\to\!\mathbb R^{m}\) satisfying  

  \[
  \dot{\bar x}(v)=f(\bar x(v))+g(\bar x(v))\,\bar u(v),\quad\forall v\in\mathbb R^{l}
  \] (Assumption 3).  
- **Prestabilizing policy**  
  A continuous controller \( \pi:\mathbb R^{n}\times\mathbb R^{l}\!\to\!\mathbb R^{m}\) with  
  \(\bar x(v)\) asymptotically stable for each fixed \(v\).  
  The augmented dynamics read  
  \[
  \dot x = f_{\pi}(x,v)=f(x)+g(x)\pi(x,v)
  \]  
  and the *augmented* state‑reference space \( \tilde D =D_{\pi}\!\times\!\mathbb R^{l}\).

### 2. Control Barrier Functions (CBFs)  
Definition (Ames et al., 2017): \(h:D\!\to\!\mathbb R\) is a CBF if  

\[
L_fh(x)+L_gh(x)u+\alpha(h(x))\ge 0,\;\forall u\in U,
\]  

with \(L_fh\) and \(L_gh\) Lie derivatives and \(\alpha\in\mathcal K_{\infty}\).  
The CBF filter is the quadratic program  

\[
\begin{aligned}
\min_{u}&\ \lVert u-\kappa(x)\rVert^{2}\\
\text{s.t. }&\ L_fh(x)+L_gh(x)u+\alpha(h(x))\ge 0,\ \forall u\in U .
\end{aligned}
\]  

where \(\kappa(x)\) is the nominal controller.

### 3. Dynamic Safety Margins (DSMs)  
For a vector‑valued function \(\Delta:\tilde D\!\to\!\mathbb R^{p}\) the set  

\[
\tilde C=\{(x,v)\in\tilde D\mid \Delta(x,v)\ge 0\}
\]  

has the properties (Definition 2)  

1. \( \tilde C\subseteq \tilde X\) (state constraints).  
2. \(\tilde C\) closed in \(\mathbb R^{n}\times\mathbb R^{l}\).  
3. Invariance: \(\dot{\Delta}\!+\!\alpha(\Delta)\ge 0\) for all \( (x,v)\in\tilde D\).  

Theorem 1 (Freire & Nicotra, 2025) states that such a DSM is a CBF for the augmented dynamics \((x,v,u,w) \mapsto (f_{\pi}(x,v),\, w)\).

### 4. Trajectory‑Based DSM  

The authors propose the following specific DSM:

\[
\boxed{\Delta(x,v)\!=\!\min_{\tau\in[0,T]}\; c\!\bigl(\Phi(\tau,x,v),v\bigr)}
\tag{30}
\]  

where  
- \(c:\mathbb R^{n}\!\times\!\mathbb R^{l}\!\to\!\mathbb R\) encodes the *state‑constraint set*  
  \[
  X_v=\{x\mid c(x,v)\ge 0\}
  \]  
- \(\Phi(\tau,x,v)\) is the solution of (5)  
  \(\dot x=f_{\pi}(x,v),\,x(0)=x\).  
- \(\tau^\*\!(x,v)\) is the argument achieving the minimum in (30).  

Lemma 1 (Section 3) shows how perturbations of the initial state \(\dot x\) affect the future prediction via the state sensitivity Jacobian \(S_x(\tau)=\partial\Phi(\tau,x^*,v)/\partial x^*\).

#### 4.1 Sensitivity Analysis  
Define:  

\[
S_x(\tau)=\frac{\partial\Phi(\tau,x,v)}{\partial x}, \qquad
S_v(\tau)=\frac{\partial\Phi(\tau,x,v)}{\partial v}
\]  

Proposition 1 proves that, if \(\partial f_{\pi}(\bar x(v),v)/\partial x\) is Hurwitz, then  

\[
\lim_{\tau\to\infty} S_x(\tau)=0,\qquad
\lim_{\tau\to\infty} S_v(\tau)=-A_\pi^{-1}\!B_\pi
\]  

where \(A_\pi=\partial f_{\pi}(\bar x(v),v)/\partial x\), \(B_\pi=\partial f_{\pi}(\bar x(v),v)/\partial v\).  
Thus the future Jacobians converge to zero (for state) or a constant (for reference), which is crucial for the Lie derivative of \(\Delta\).

### 4.2 Finite‑Horizon Extension  
Computing \(\tau^\*\) over \([0,T]\) instead of \([0,\infty)\) yields the *terminal DSM*  

\[
\Delta_T(x,v)=\Delta\bigl(\Phi(T,x,v),v\bigr)
\]  

Proposition 2 adds \(\Delta_T\) to \(\Delta\) by defining  

\[
\Delta_2(x,v)=\min_{\tau\in[0,T]}\bigl(c(\Phi(\tau,x,v),v)-c(\Phi(T,x,v),v)\bigr)
\]  

and setting  

\[
\Delta_1(x,v)=\min_{\tau\in[0,T]}\delta(\tau,x,v),\quad\delta(\tau,x,v)=c(\Phi(\tau,x,v),v)
\]  

Both \(\Delta_1, \Delta_2\) are DSMs; their union yields the full DSM.

### 4.3 Smoothness – Clarke Jacobian  
Because \(\tau^\*\!\) may not be unique, \(\Delta\) can be nondifferentiable.  Proposition 3 establishes that under the *sufficient condition*  

\[
\dot\delta(\tau,x,v,u,w)+\alpha\bigl(\delta(\tau,x,v)\bigr)\ge 0,\qquad\forall \tau\in[0,T]
\tag{42}
\]  

the Clarke generalized Jacobian of \(\Delta_1\) satisfies the CBF inequality in the sense of generalized Jacobians.  This removes the requirement of a unique minimizing \(\tau^\*\).

### 4.4 Feasibility of the Safety Filter  
Combining all considerations yields the *tractable* DSM‑CBF filter (eq. 48):

\[
\begin{aligned}
\min_{u,w}\ &\|u-\kappa(x)\|^2\\
\text{s.t. }\ &\ \sum_{\tau\in\boldsymbol T}\,\bigl(
\dot\delta(\tau,x,v,u,w)+\alpha\bigl(\delta(\tau,x,v)\bigr)\bigr)\ge 0\\
&\ u\in U,\ w\in\mathbb R^{l}
\end{aligned}
\]  

where \(\boldsymbol T\subset[0,T]\) is a finite set of simulation time points.  If the control zone \(U\) is polyhedral this is a quadratic program that remains feasible for every \((x,v)\in\tilde C\) (Corollary 1).  Note that in the QP the *predicted trajectories* \(\Phi(\tau),S_x(\tau),S_v(\tau)\) are pre‑computed and thus negligible in cost relative to model predictive control.

---

## Experiments / Data / Results  

### Problem Setup – Inverted Pendulum on a Cart  
- State vector \(x=[x,\theta,\dot x,\dot\theta]^{\top}\).  
- Dynamics:  

\[
\ddot q=M(q)^{-1}\bigl(-c(q,\dot q)+\tau\bigr),
\]  

with \(M(q)=\begin{bmatrix}m_c+m_p & m_pL\cos\theta\\ m_pL\cos\theta & m_pL^2\end{bmatrix}\), dampings \(c(q,\dot q)=[0,~m_pL\dot\theta^2\sin\theta]^{\top}\).  
 Parameters: \(m_c=1\) kg, \(m_p=0.5\) kg, \(L=0.7\) m, \(g=9.81\) m/s².  

- **Equilibrium manifold** \(\bar x(v)=[v,\pi,0,0]^{\top}\), \(\bar u(v)=0\).  

- **Prestabilizing LQR** \(\pi(x,v)=\Bigl[-0.44\;\; 35.3\;\; -1.4\;\; 8.0\Bigr]\,(x-\bar x(v))\).  

### Constraints  
- State:  
  \( |x| \le 4.5\), \(|\theta-\pi|\le \pi/9\).  
  (ensures pendulum stays in its attraction basin).  
- Input: \( |u|\le 20\).  

Encoded with \(c(x,v)=\min\{\,x_{\max}-x,\;x+x_{\max},\;\theta_{\max}+\theta, \;\theta_{\max}-\theta \}\).  

### Nominal & Safety Controllers  
1. **Nominal** \(\kappa(x)=\Bigl[-35\;\;150\;\;-20\;\;50\Bigr]\,(x-\bar x(0))\).  
2. **Lyapunov‑based DSM‑CBF** (previously proposed; uses a Lyapunov DSM, more conservative).  
3. **Explicit Reference Governor (ERG)** (Chen et al., 2018).  
4. **Backup CBF** (Chen et al., 2021) – uses a *backup* policy that fixes \(v=x(t)\).  
5. **Proposed Traj‑DSM‑CBF** – using DSM (30) with horizon \(T=10\,\text{s}\), α(c)=100 c, α_T(c)=400 c, feasibility margin η=0.1.  

### Results (Fig. 1)  
- The *Proposed* controller achieves the fastest convergence from the initial to desired reference \(r=4\) while strictly satisfying all state and input constraints.  
- *Nominal* controller is unsafe: the pendulum leaves the attraction basin, violating the θ constraint.  
- *Lyapunov‑based DSM‑CBF* keeps safety but is overly conservative: trajectory lag and large control effort.  
- *ERG* follows the reference slower than the proposed method, as RGs are fundamentally constrained by invariant set invariance.  
- *Backup CBF* achieves safety, but its response is much slower because the reference is forced to the current state, leaving little freedom for proactive maneuvering.  

The comparison underscores the advantage of parameterizing the backup policy by the *equilibrium manifold* and allowing the reference \(v\) to move freely.

---

## Discussion & Analysis  

**Robustness of the SCM framework.**  
- The sensitivity analysis (Proposition 1) guarantees that perturbations die out quickly, enabling the use of *open‑loop* predictions inside a *closed‑loop* filter.  
- The Clarke Jacobian approach (Prop. 3) resolves nonsmoothness with a mild Lie‑derivative inequality that can be verified in practice.  
- Feasibility is guaranteed (Corollary 1); the only user‑tunable parameter is the horizon \(T\).  

**Computational cost.**  
- All trajectory sensitivities are pre‑computed once per QP call; attraction to the ‑generated QP cost is comparable to standard model‐predictive control.  

**Comparison to other CBF design methods.**  
- Unlike SOS or machine‑learning approaches (Harms et al., 2024; Dai et al., 2024), the method is *fully constructive*, relies only on analytic derivatives, and inherits invariance proofs from RG theory.  
- It generalizes directly from the *explicit reference governor* framework (Garone et al., 2017; Nicotra & Garone, 2018) but removes the explicit need for invariant sets, instead using DSMs as CBFs.  

**Open questions.**  
- DSM minimizer uniqueness: While Proposition 3 does not require uniqueness, practical cost may increase if the set \(\tau^\*\) is large.  
- Disturbance robustness: The current analysis assumes exact knowledge of \(f_{\pi}\).  Future work will extend to bounded perturbations.  
- Extension to high relative‑degree constraints (e.g., velocity constraints) would necessitate higher‑order DSMs.  

---

## Conclusions  
The paper delivers a *complete, general* construction of control barrier functions for any locally stabilizable, control‑affine system with arbitrary state and input constraints.  By concatenating the state and a *parameterized* reference, defining a trajectory‑based dynamic safety margin, and rigorously handling sensitivity Jacobians and nonsmoothness, the authors prove that the resulting filter is a valid CBF and always feasible.  The approach shows superior performance on an inverted pendulum on a cart compared to several state‑of‑the‑art CBFs and reference governors, highlighting its practical value.

---

## Key Claims & Contributions  

| Claim | Supporting Evidence |
|---|---|
| **C1.** *DSMs are CBFs for the augmented system.* – Theorem 1, based on definition 2 and Lie‑derivative inequalities. |
| **C2.** *Sensitivity Jacobians converge to zero/constant* – Proposition 1, proved via Lyapunov analysis. |
| **C3.** *Trajectory‑based DSM (30) satisfies DSM property* – Theorem 2, with finite‑horizon extension in Proposition 2. |
| **C4.** *Non‑smooth DSM still satisfies CBF condition in Clarke sense* – Proposition 3, using inequality (42). |
| **C5.** *QP safety filter (48) is always feasible* – Corollary 1 with feasibility margin η. |
| **C6.** *Proof‑of‑concept on inverted pendulum* – simulation (Fig. 1) shows constraint satisfaction and fastest reference following. |

---

## Definitions & Key Terms  

- **Control barrier function (CBF)** – A differentiable function \(h(x)\) whose Lie derivatives satisfy a lower bound ensuring forward invariance of \( \{x| h(x)\ge 0\}\).  
- **Dynamic safety margin (DSM)** – A vector‑valued function \(\Delta(x,v)\) defined on the augmented state‑reference space, whose Lie derivative is bounded by a class‑\(\mathcal K_{\infty}\) function.  It plays the role of a CBF.  
- **Trajectory‑based DSM** – DSM defined as the minimum future violation along the trajectory of a prestabilized controller (eq. 30).  
- **Sensitivity Jacobian** – \(S_x(\tau)=\partial\Phi(\tau)/\partial x\), \(S_v(\tau)=\partial\Phi(\tau)/\partial v\), describing how small perturbations propagate along predicted trajectories.  
- **Clarke generalized Jacobian** – Extension of the Jacobian to locally Lipschitz functions, used to handle nondifferentiability of \(\Delta\).  

---

## Important Figures & Tables  

- **Figure 1** – Simulation of the inverted pendulum on a cart under five control strategies. The top panel shows the cart position, bottom panel the pendulum angle and input; shadowed regions indicate nominal, DSM‑CBF, ERG, backup‑CBF, and proposed DSM‑CBF envelopes. The proposed method reaches the reference fastest while remaining inside all constraints.  
- **Algorithm 1** – Pseudocode for the DSM‑CBF safety filter:  
  ```
  function SafetyFilter(x, v)
      Φ(τ) ← solve (13) for τ∈[0,T]
      Sx(τ) ← solve (17) 
      Sv(τ) ← solve (19)
      (u,w) ← solve (48)
      return (u,w)
  end function
  ```
  Note that the predictions are pre‑computed and independent of the optimization variables.  

---

## Limitations & Open Questions  

1. **Assumption of unique minimizer** – The method does not exclude multiple minima; only necessary condition (42) is imposed.  
2. **Compute‑time for dense horizons** – Large \(T\) or many candidate points \(\boldsymbol T\) may increase QP size though still tractable.  
3. **Disturbance robustness not yet proven** – Future work will incorporate bounded model error or sensor noise.  
4. **High‑order constraints** – The current framework handles first‑order bounds; higher‑relative‑degree constraints would require extended DSM definitions.  

---

## References to Original Sections  

- *Assumptions & definitions*: Section 2 (2.1–2.3).  
- *Sensitivity analysis*: Section 3 (3.3–3.4).  
- *Trajectory‑based DSM*: Section 4.  
- *Feasibility proof*: Section 4.3.  
- *Experiments*: Section 5.  
- *Algorithm*: Table in Section 4.3.  

---

**Thank you for reading this concise, yet exhaustive summary of “Designing Control Barrier Functions Using a Dynamic Backup Policy.”**