**Title & Citation**  
*Whole-Body Model Predictive Control for Spin‑Aware Quadrupedal Table Tennis*  
David Nguyen ¹,³, Zulfiqar Zaidi ²,³, Kevin Karol ³, Jessica Hodgins ³, Zhaoming Xie ³  
¹ MIT, ² Georgia Institute of Technology, ³ RAI Institute, Cambridge, MA.  

**Abstract**  
The authors present a complete robotic table‑tennis system that operates the Boston Dynamics Spot quadruped with a 6‑DoF arm. The system combines: (i) external high‑speed RGB cameras for accurate 3‑D ball localization; (ii) model‑based trajectory prediction augmented with a residual neural network to estimate ball spin and predict impact state; (iii) a constrained optimization “aiming” module that selects paddle pose, velocity, and normal for a desired landing point and outgoing spin; and (iv) a novel whole‑body **Model Predictive Control (MPC)** that uses parametric Bezier curves to plan a dynamic swing satisfying the aiming constraints and a whole‑body torque‑generation controller. Empirical results on Spot demonstrate ≈ 75 % return rates for incoming spins up to 280 rad s⁻¹, and the ability to impart outgoing spins up to 200 rad s⁻¹, matching human‑style stroke strategies. The system also demonstrates rally play against human opponents.

---

### Introduction & Motivation
- Table tennis demands sub‑second perception, spin inference, strategic targeting and agile striking.  
- Existing robot‑paddle systems largely use fixed arms or gantries, limiting reach and balance.  
- Legged platforms must handle body dynamics and balance while executing high‑speed swings.  
- Goal: create a Spot‑based system that can perceive, predict, aim, and control to return balls with spins comparable to skilled humans.  

**Claim 1 (Design Scope):**  
“A quadrupedal system capable of handling incoming spin up to 280 rad s⁻¹ and generating outgoing spin up to 200 rad s⁻¹, surpassing prior work [9], [10].”

---

### Methods / Approach

| Sub‑Module | Key Steps | Software & Parameters |
|-------------|----------|-----------------------|
| **Ball Detection** | • Stereo pair of Lucid Arena PoE RGB cameras (1400 × 1080 @165 fps).  <br>• Extrinsic calibration via PnP using table corners.  <br>• Two‑stage pipeline: background subtraction → YOLOv3 CNN on 480 × 480 warp (~4 ms). | YOLO fine‑tuned on custom dataset; 4 ms latency total. |
| **Ball Trajectory Prediction & Spin Estimation** | • Derive linear velocity v from polynomial fit of position history.  <br>• Estimate angular velocity ω via least‑squares from Equation (1) [22] (handling drag CD and Magnus CM).  <br>• Residual network trained on 650 trajectories (data‑augmented ± restricted rotations).  <br>• Integrate using CM dynamics + table rebound model (Nonomura). | Residual network performance: R² 0.70 vs 0.42 “model‑only” (Fig. 3). |
| **Aiming Planner** | • Input: target landing position \(p_{\text{land}}\), desired outgoing spin ω⁺, time \(t_{\text{land}}\).  <br>• Constraint optimization (Eq. 3) solves for paddle state \((p_{\text{des}}, v_{\text{des}}, n_{\text{des}})\).  <br>• Uses Sequential Quadratic Programming (SQP) with OSQP, 4 iterations (~1 ms). | See Fig. 4 – convergence for drive, loop, chop. |
| **Whole‑Body MPC** | • Kinematic planner: 8‑control‑point Bezier curves for each of Spot’s 24 joints (Eq. 4).  <br>• Constraints: start state, joint limits, stance feet (no step), paddle strike conditions at \(t_s\).  <br>• Slack variables for decoupling; cost regularizes acceleration (f_a) and proximity to rest pose (f_r) (Eq. 6–7).  <br>• Whole‑body dynamic controller: solves quadratic program for torques (Eq. 8) considering mass matrix M, Coriolis C, gravity τ_g, foot contact forces λ, and friction cone. | OSQP for QP; MPC re‑planned at 100 Hz (Fig. 5). |

**Technical Definitions**

* **Spin (ω):** Angular velocity vector of the ball, expressed in ball‑center frame.  
* **Drag Coefficient (C_D)** and **Magnus Coefficient (C_M)**: Lumped aerodynamic parameters.  
* **Ball state \(x_b = [r_b, \dot{r}_b, ω_b]^\top\)**.  
* **Sequential Quadratic Programming (SQP):** iterative solve of convex QP approximations to handle non‑linear constraints.  
* **Bezier Bezier(control points \(q_c\))**: parametric curve generating joint trajectories.  
* **Full‑body controller**: Solves for torques abiding robot dynamics and contact constraints.  

---

### Experiments / Data / Results

| Metric | Observation | Source |
|--------|-------------|--------|
| **Ball Localization Accuracy** | Median error < 1 cm per axis (Fig. 6). | Fig. 6 |
| **Prediction Timing & Position Error** | Reverse spin estimate converges within 150 ms; median position error < 7.5 cm at strike (Fig. 7). | Fig. 7 |
| **Vanilla Swing Accuracy** | Heatmaps (Fig. 8) show < 0.75 cm, < 0.5 m s⁻¹, < 20° errors across 3 m² workspace. | Fig. 8 |
| **Return Rate** | 150 trials → 90.1 % returned. With slight bias in aiming (p_land) the system returned reliably. | Fig. 9 |
| **Return Rate vs Spin Estimation** | Table I: mean return 75.2 % with residual network; 52.0 % with LS only; 27.2 % with no spin detect. | Table I |
| **Outgoing Spin Accuracy** | Table II: mean ω⁺ within ≈ 20 rad s⁻¹ of target across 125–200 rad s⁻¹. | Table II |
| **Human Rally** | Achieved > 10 rallies against a human opponent, handling varying spin. | Section IV.E |

---

### Discussion & Analysis

1. **Perception:** 165 fps cameras cross‑display less than 4 ms total latency; color‑based detection is robust; using IL‑based YOLO fine‑tuning overcame domain shift.  
2. **Prediction:** 650‑trajectory training set plus residual network improved spin estimation R² from 0.42 to 0.70 (Fig. 3). Predictive model handles 280 rad s⁻¹ incoming spin reliably.  
3. **Aiming MPC:** Convex SQP converged within 4 iterations, < 1 ms. Continuous strike constraints handled via barrel—negative inter-iteration loops.  
4. **Swing MPC:** Bezier parametric curves allow continuous strike constraint; cost regularization avoids excessive acceleration.  
5. **Return Performance:** Causal effect of residual network evident: from 27 % to 75 % return.  
6. **Spin Generation:** Outgoing spin variance ≈ 16–24 rad s⁻¹—close to human "loop" or "chop".  
7. **Limitations & Future Work** (Section V):
   * Need on‑board, faster cameras for faster ball/gameplay.  
   * Opponent motion prediction currently absent; future integration may use human pose.  
   * Swing MPC excludes stepping; advanced strategy may combine RL for footwork.  
   * Stro­ke strategy heuristic only; adaptive opponent‑aware strategies remain.  

---

### Conclusions

The paper demonstrates a fully functional Spot‑based table‑tennis system that perceives, predicts, aims, and controls a dynamic arm/paddle sweep to return balls with high spin. The approach leverages 3‑D stereo vision, analytic‐plus‐residual spin inference, fully constrained aiming, and holistic whole‑body MPC. Evaluation suggests ≈ 75 % return accuracy across a large spin and speed range, while also generating realistic human‑style spin and stroke patterns. The authors identify perception, prediction, and strategy as open research directions.

---

### Key Claims & Contributions

1. **First quadrupedal Spot system that can return / impart spins comparable to skilled humans.**  
2. **Novel whole‑body MPC formulation** that integrates continuous strike constraints using Bezier basis.  
3. **Residual neural network** that improves spin estimate to 0.70 R², enabling correct swing adaptation.  
4. **Automatic emergence of human‑style stroke libraries** (loop, drive, chop) from a unified optimization.  
5. **Empirical return rates** of 90 % return and 75 % with varying spins—outperforming prior robotic table‑tennis approaches.

---

### Definitions & Key Terms

* **Spot robot** – Boston Dynamics Spot quadruped with 24 articulations + 6‑DoF arm.  
* **Incoming Spin (ω⁻)** – ball’s measured angular velocity before impact.  
* **Outgoing Spin (ω⁺)** – desired ball angular velocity after impact.  
* **MM-:**: clamp? (none).  
* **Ball impact plane** – 0.5 m in front of robot (in world coordinates).  

---

### Important Figures & Tables

| Figure | Description |
|--------|-------------|
| **Fig. 1** – qualitative rendering of Spot swinging. |
| **Fig. 2** – system diagram: cameras → detection → prediction → aiming → MPC → robot. |
| **Fig. 3** – R² performance of model‑only vs residual‐augmented spin estimation. |
| **Fig. 4** – AIM optimization convergence for 3 stroke types. |
| **Fig. 5** – examples of swing trajectories (loop, drive, chop). |
| **Fig. 6** – violin plots of 3‑D localization error vs Vicon ground truth. |
| **Fig. 7** – predictive error over flight time, threshold 7.5 cm. |
| **Fig. 8** – heatmaps of paddle position, velocity, orientation error for multiple shots. |
| **Fig. 9** – landing locations for 3 targets (right, center, left). |
| **Fig. 10** – differing spin hardware examples: back‑spin and top‑spin shots. |

| Table | Description |
|-------|-------------|
| **Table I** – return rates for different spin detection architectures (None, LS, Residual). |
| **Table II** – mean/w. σ of imparted spin for 4 target spin speeds. |

---

### Limitations & Open Questions

* **Perception** – off‑board cameras; no adaptive FL‑sensor pipeline for on‑board imagers.  
* **Opponent modeling** – lacking view of human opponent; future work may incorporate pose estimation to infer spin or trajectory.  
* **Footstep dynamics** – stick to stance feet only; complete balance/step control not integrated → limits rally speed or server strategy.  
* **Strategy** – no explicit learning of tactical shot placement; they use simple heuristics.  
* **Parameter robustness** – CD, CM, and friction cones rely on assumptions; effect across varying table surfaces not studied.  

---

### References to Original Sections

* **Ball detection pipeline** – Section III‑A (2).  
* **Spin estimation mechanics** – Section III‑B (2).  
* **Aiming optimization** – Section III‑C.  
* **Whole‑body MPC** – Section III‑D (1–2).  
* **Performance metrics** – Section IV‑A, B, C, D, E.  
* **Key claims** – Section I, V.  
* **Limitations** – Section V.  
* **Figures and Tables** – as listed above.  

---

### Supplementary Material

* Video: https://www.youtube.com/watch?v=3GrnkxOeC14 (animations + hardware demonstrations).  

---