## 1 Title & Citation
**Degradation‑Aware Model Predictive Control for Battery Swapping Stations under Energy Arbitrage**  
Ruochen Li, Zhichao Chen, Zhaoting Zhang, Renjie Guo, Zhankun Sun, Jiwei Yao, Jiaze Ma  
Department of Systems Engineering, City University of Hong Kong – 1  
Department of Decision Analytics & Operations, City University of Hong Kong – 2  
Department of Chemical Engineering, University of Utah – 3  

---

## 2 Abstract
This paper introduces **BSS‑MPC**, a real‑time, degradation‑aware Model Predictive Control (MPC) framework that schedules the operation of battery swapping stations (BSS). The method optimally trades energy arbitrage income against long‑term battery degradation by integrating a high‑fidelity physics‑based capacity‑fade model (Single‑Particle Model) through a Kriging surrogate. The resulting mixed‑integer optimal control problem is solved with tailored algorithms that enforce state, control and swapping constraints. Simulation on a 200‑battery community shows that BSS‑MPC outperforms rule‑based and low‑fidelity baselines, achieving lower energy cost, reduced capacity fade, and strict satisfaction of Electric‑Vehicle (EV) swapping demands.

---

## 3 Introduction & Motivation
- **EV adoption bottlenecks**: range anxiety + charging wait times drive demand for battery‑swap technologies.  
- **BSS benefits**: fast (≈3 min swaps), decouples battery ownership, centralized battery handling – reduces grid peak loads, improves battery life, facilitates recycling.  
- **Economic barrier**: high upfront/maintenance costs vs. limited consumer willingness to pay service fees.  
- **Opportunity**: view BSS as a **grid‑integrated energy storage** asset; use arbitrage (charge at low prices, discharge at high prices).  
- **Challenges**: balancing short‑term service reliability, long‑term asset health, and market revenue.  
- **Literature gaps**:  
  1) Simplistic degradation models (SOC‑only, quadratic power penalties).  
  2) Limited tractability of high‑fidelity models with integer decisions.  

The authors propose BSS‑MPC: a first real‑time MPC that incorporates a physics‑informed capacity‑fade model into a mixed‑integer formulation, enabling simultaneous optimisation of swapping logistics, energy arbitrage, and battery health.

---

## 4 Methods / Approach

### 4.1 High‑Fidelity Battery Model – Single Particle Model (SPM)

*Physics* – captures inter‑diffusion in spherical particles, Butler–Volmer kinetics, SEI growth, and cumulative capacity fade.  
*Equations* – (3.2)–(3.13) from Ref. [36] were adapted for LiFePO₄ cells (parameters from Ref. [37]).  
*States*: \(\bar{C}_p,\,\bar{C}_n,\, \delta_{SEI},\, c_f\).  
*Algebraics*: surface concentrations, currents, potentials.  
*Inputs*: applied power \(P\).  
*Result*: accurate SOC and capacity evolution; suitable for low‑charge‑rates (1 C).

### 4.2 Surrogate via Kriging

*Goal*: reduce numerical stiffness and enable tractable optimization.  
*Training*: offline sample trajectories from SPM; construct training set \(X,\;y=f(X)\).  
*Surrogate*:  
\[
   \Delta \mathbf{x}_{i+1} \approx f_{\text{Kriging}}(\mathbf{x}_i,\;u_i)
\] with mean \(\mu_0\) and RBF kernel.  
*Benefit*: preserves fidelity while simplifying from DAE to ODE, avoiding exponential/hyperbolic instability.  
*Validation*: Fig. 2 shows relative error <0.002 for degradation states and <0.03 for concentration states.

### 4.3 Discrete‑Time State Transition & Swapping

*time‑step* \(\Delta t = 1\) h (sufficient for full charge at 1 C).  
*State vector* \(\mathbf{x}_i = \{[C_p,C_n,\delta_{SEI},c_f,\dots]\}_k\) for all \(k=1{\dots}K\).  
*Control* \(\mathbf{u}_i = \{P_{k,i}\}_k\).  
*Binary* \(b_{k,i}\in\{0,1\}\) – indicates if battery \(k\) is swapped out at time \(i\).  
*Constraint* \(S_i=\sum_{k}b_{k,i}\) known demand;  
*Swapping feasibility*  
\[
   1-\varepsilon \le C_p,b_i \le 1 \quad\forall k,i
\]
ensures only fully charged batteries are swapped out (ε≈10⁻⁶).  
*State evolution*  
\[
  \mathbf{x}_{i+1} = \mathbf{x}_{\text{swap}} + \Delta\mathbf{x}_{i+1}
\]  
using Kriging surrogate for \(\Delta\mathbf{x}_{i+1}\).

### 4.4 Objective Function

\[
J = \sum_{i}\Bigl( R_i - P_i\Bigr)
\]
with  
*Reward*  
\[
 R_i = \sum_{k}\rho_i\, P_{k,i}
\]  
(where \(\rho_i\) is the day‑ahead price).  
*Penalty*  
\[
 P_i = w_1 c_{f,k}(t) + w_2\,\mathrm{var}(c_{f,k}(t))
\]  
where \(w_1,w_2\) are tunable; i.e., discourages high fading and uneven utilisation.  
*Penalties* are sub‑quadratic to fit the physics.

### 4.5 Path, State & Control Constraints

- **Power bounds**: \(P_{k,i}\in[-P_{\max},P_{\max}]\).  
- **SOC bounds**: \(C_{p,k,i}\in[0.7,1]\) (allowed 0.001 slack).  
- **Swapping control**: all \(b_{k,i}\in\{0,1\}\), with cardinality constraint \(S_i\).  
- **Big‑M linearisation**: Equations (3.32)–(3.34) replace bilinear term \(b_{k,i} P_{k,i}\) with linear constraints using large \(M\).

### 4.6 MPC Framework

- **Prediction horizon**: 24 h (full day).  
- **Receding‑horizon loop**: solve MINLP for horizon \([i,i+N-1]\), apply first control action \(u_i\), observe real state \(x_{i+1}\), shift horizon.  
- **Algorithm**: see “Algorithm BSS‑MPC” – iterative surrogate refinement (adding points if relative error > tolerance).  
- **Solvers**: Julia JuMP + DICOPT; DICOPT uses IPOPT (NLP) and CPLEX (MILP).  
- **Runtime**: ~20–40 s per iteration (warm‑start).

---

## 5 Experiments / Data / Results

### 5.1 Simulation Setup

- **Community**: 200 LiFePO₄ batteries; 21 reserve at station, 179 in EVs.  
- **Demand**: first‑in‑first‑out swap queue; each arriving driver returns the battery they used, receives next ready, appended to end.  
- **Penalties**: $1 per 10 % SOC shortfall in swapping.  
- **Swapping constraints**: allow no last‑minute overcharge/discharge, safety limits maintained.

### 5.2 Baseline Strategies

| Strategy | Model | Decision Horizon | Charge Penalty | Optimization Type | Solving Complexity |
|----------|-------|-----------------|----------------|-------------------|---------------------|
| **Rule‑Based** | Heuristic | 1 h | None | None | Lowest |
| **Low‑Fidelity** | SOC‑only + power² penalty | 1 h | Power² | MIQP | Moderate |
| **BSS‑MPC** | Kriging SPM + full objective | 24 h | None | MINLP | High (20–40 s) |

### 5.3 One‑Day Planning (Figure 4)

- **Behavior**: Rule‑Based ignores price variations → constant full‑charge strategy.  
- **Low‑Fidelity & BSS‑MPC**: charge during low price/demand low periods, sell during price peaks (hours 7‑8), charge again during dip (hour 9), small discharge at peak (hour 10).  
- **Commonality**: after hour 11 all strategies converge due to high demand; arbitrage profit shrinks.  

### 5.4 Rolling Horizon Outcomes (Figure 5)

- Examined one battery slot.  
- **Initial plan**: matches rolling plan until hour 10; afterwards decisions diverge due to updated predictions and potential model errors.  
- **Implication**: incremental updates allow adaptation and reduce long‑horizon error accumulation.

### 5.5 Half‑Year Comparative Study (Figures 6–8, Table 2)

#### 5.5.1 Profit & Capacity Fade (Figure 6)

- **Rule‑Based**: lowest profit, highest average capacity fade (~100 % baseline).  
- **Low‑Fidelity**: similar profit to BSS‑MPC, reduces average fade by ~18 %.  
- **BSS‑MPC (high‑profit)**: 24 % profit gain over rule‑based, 16 % reduction in average fade.  
- **BSS‑MPC (low‑cf)**: lowest fade (70 %) at cost of ~14 % lower profit vs. rule‑based.

#### 5.5.2 SOC Constraint Satisfaction (Figure 7)

- **Low‑Fidelity**: 40 % of selected batteries below threshold (ε=0.1).  
- **BSS‑MPC**: zero violations using ε=0.001.  
- **Rule‑Based**: also zero violations by design.

#### 5.5.3 Cost Breakdown (Figure 8)

1. **Electricity cost** – lowest for high‑profit BSS‑MPC (energetic arbitrage).  
2. **Depreciation / Fade cost** – lowest for low‑cf BSS‑MPC, still lower than low‑fidelity.  
3. **Penalty cost** – negligible for BSS‑MPC & rule‑based (strict SOC).  
- **Overall**: BSS‑MPC delivers least total cost, highest profit.

#### 5.5.4 Summary Table (Table 2)

| Metric | Rule‑Based | Low‑Fidelity | BSS‑MPC (high‑profit) | BSS‑MPC (low‑cf) |
|--------|-------------|---------------|------------------------|-------------------|
| Normalized Loss | 100 % | 98.6 % | 76.0 % | 85.3 % |
| Avg c_f | 100 % | 82.8 % | 79.9 % | 70.1 % |
| c_f Variance | 100 % | 1160 % | 176 % | 213 % |
| SOC Compliance | 100 % | 60 % | 100 % | 100 % |

Values are relative to Rule‑Based; lower loss/variance indicates better performance. BSS‑MPC consistently achieves superior performance across all metrics.

### 5.6 Computational Performance

- Each iteration ≈20–40 s (warm‑start).  
- Surrogate refinement ensures relative error < 10⁻³ throughout the 180‑day run.  

---

## 6 Discussion & Analysis

1. **Model fidelity matters**: The Kriging surrogate matches SPM closely, enabling accurate forecasting of SOC and fading while avoiding DAE stiffness.  
2. **Optimization horizon**: 24 h permits enough look-ahead to capture significant price fluctuations and swap demand; rolling horizon updates mitigate error propagation.  
3. **Profit vs. degradation trade‑off**: Two BSS‑MPC variants demonstrate tunable balance: high‑profit emphasises arbitrage income, low‑cf prioritises battery life.  
4. **SOC constraint enforcement**: BSS‑MPC absolutely avoids swapouts below threshold, unlike low‑fidelity which fails due to simplified dynamics.  
5. **Cost structure**: BSS‑MPC’s penalty terms explicitly penalise both fade magnitude and utilisation variance, leading to uniform degradation and lower long‑term depreciation.  
6. **Scalability**: Current runtime is acceptable for real‑time operation at a single station; larger fleets would require further surrogate acceleration (future work).  

---

## 7 Conclusion

BSS‑MPC is the first real‑time, degradation‑aware MPC framework for battery swapping stations that embeds a physics‑based capacity‑fade model via a Kriging surrogate. It simultaneously optimises swapping logistics, energy arbitrage, and battery health, outperforming rule‑based and low‑fidelity baselines in profit, degradation, and SOC compliance. The authors propose future work on faster surrogate development and stochastic MPC for price/demand uncertainty.

---

## 8 Key Claims & Contributions

- **Claim**: BSS‑MPC achieves higher cumulative profit (≈24 % over rule‑based) while reducing capacity fade (≈16 %) in a realistic 200‑battery simulation.  
- **Claim**: Kriging surrogate reproduces the SPM dynamics with < 0.002 relative error for degradation states, enabling tractable MINLP solving.  
- **Claim**: BSS‑MPC satisfies SOC constraints (ε = 10⁻³) with zero violations, whereas low‑fidelity fails.  
- **Contribution**: Integrating a high‑fidelity electrochemical model into MPC for the first time in a BSS context.  
- **Contribution**: Formulating BSS operation as a mixed‑integer nonlinear programming problem, solved with Big‑M linearisation and warm‑started DICOPT.  
- **Contribution**: Demonstrating clear separation between profit‑focusing and fade‑focusing BSS‑MPC variants, giving operators tunable control over economics versus longevity.  

---

## 9 Definitions & Key Terms

| Term | Definition |
|------|-------------|
| **BSS** | Battery Swapping Station – facility that swaps depleted EV batteries with fully charged ones (robotic or manual). |
| **MPC** | Model Predictive Control – a receding‑horizon optimisation framework that uses a predictive model to determine control actions. |
| **SPM** | Single‑Particle Model – a physics‑based battery model that reduces radial diffusion to spherical particle average dynamics. |
| **Kriging** | Spatial interpolation surrogate modelling, used to approximate the SPM state transition from input‑state pairs. |
| **MINLP** | Mixed‑Integer Nonlinear Programming – optimisation with continuous and binary variables, nonlinear constraints. |
| **Big‑M** | Linearisation technique replacing bilinear terms with linear constraints using a large constant \(M\). |
| **\(c_f\)** | Cumulative capacity fade – a state variable capturing total irreversible capacity loss. |
| **\(P_{k,i}\)** | Power exchanged (negative = charging, positive = discharging) for battery \(k\) at time \(i\). |
| **\(b_{k,i}\)** | Binary variable indicating if battery \(k\) is swapped out at time \(i\). |
| **\(\rho_i\)** | Day‑ahead market price at time \(i\). |
| **\(S_i\)** | Swapping demand (number of swaps) at hour \(i\) (known ahead). |
| **\(\epsilon\)** | Tolerance for swapping feasibility (≈10⁻⁶ in SPM, 10⁻³ in simulations). |

---

## 10 Important Figures & Tables

| Figure | Content | Significance |
|--------|----------|---------------|
| **Fig. 1** | Schematic of BSS management with energy market arbitrage | Illustrates overall system architecture. |
| **Fig. 2** | Histogram of Kriging fitting error for C_avg*p, C_avg*n, δ_SEI, c_f | Shows surrogate accuracy. |
| **Fig. 3** | Heatmap of swap demand & price over a 24‑h period | Demonstrates typical daily variations. |
| **Fig. 4** | One‑day scheduling of BSS‑MPC vs baselines | Visualises differing strategies. |
| **Fig. 5** | Plan vs Realisation: charging, swaps, SOC over a day | Highlights rolling horizon adjustments. |
| **Fig. 6** | Cumulative profit and average c_f over 180 days | Quantifies performance differences. |
| **Fig. 7** | SOC constraint violations across strategies | Demonstrates feasibility. |
| **Fig. 8** | Cost breakdown (electricity, depreciation, penalties) | Illustrates where savings come from. |
| **Table 2** | Comparison across four metrics (profit, fade, variance, SOC compliance) | Summary of relative performance. |

---

## 11 Limitations & Open Questions

1. **Model assumption**: Batteries in EVs assumed to discharge only within a stable operating range; real driver behaviour may cause deviations.  
2. **Price predictability**: 24‑h optimization presumes deterministic day‑ahead prices; future work suggests stochastic MPC for uncertain grids.  
3. **Computational scalability**: While 20–40 s per iteration is feasible for a single station, real deployments with larger fleets or finer time‑steps might need faster surrogate models or decomposition.  
4. **State tolerance**: ε is empirically chosen; severe discretization errors might arise in extreme scenarios.  
5. **Physical limits**: The surrogate matches SPM but could still mis‑predict under aggressive charging/discharging not captured in training data.  
6. **Long‑term mission**: The simulation evaluated a 180‑day horizon only; longer‑term interactions (e.g., demand forecasts, network constraints) are future extensions.

---

## 12 References to Original Sections

- **Model equations**: SPM equations (3.2)–(3.13); Kriging surrogate (3.19)–(3.20).  
- **Constraints & objectives**: State dynamics (3.21), reward/penalty (3.26), Big‑M (3.32)–(3.34).  
- **Algorithm**: Algorithm “BSS‑MPC” (pseudocode).  
- **Results**: One‑day plan (Fig. 4), rolling horizon (Fig. 5), cumulative profits (Fig. 6), SOC violations (Fig. 7), cost breakdown (Fig. 8), Table 2.  
- **Conclusion**: “Conclusion” section.

---

## 13 Executive Summary / Key Takeaways   (Optional)

- BSS‑MPC finds optimal energy and battery‑swap schedules by embedding a physics‑based degradation model via a Kriging surrogate.  
- Compared to rule‑based and low‑fidelity strategies, BSS‑MPC improves profit (~24 % vs rule‑based), reduces capacity fade (~16 %, 70 % vs 100 % for low‑cf), and enforces SOC constraints strictly.  
- The methodology is tractable: a 24‑h MINLP solved in 20–40 s per step with warm‑start.  
- Future work: accelerate surrogates, embrace stochastic price/demand forecasting, scale to larger fleets.

---